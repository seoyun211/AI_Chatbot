<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Baekjoon Chatbot</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ê¸°ì¡´ style-popupì€ ë°ì€ í…Œë§ˆ */
    #style-popup {
      background: white;
      color: black;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      display: none;
    }

    /* ë‹¤í¬ ëª¨ë“œ ì „ìš© style-popup */
    body.dark-mode #style-popup {
      background: #333;
      color: #fff;
      border: 2px solid #888;
    }

    body.dark-mode #style-popup button {
      background-color: #444;
      color: #fff;
      border: 1px solid #aaa;
    }

    body.dark-mode #style-popup button:hover {
      background-color: #555;
    }

    .button-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .chat-button {
      padding: 10px 15px;
      background-color: #f5f5f5;
      color: rgb(16, 43, 30);
      border: none;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .chat-button:hover {
      background-color: #bdbdbd
    }

    /* ì¼ë°˜ ëª¨ë“œì—ì„œ ë©”ë‰´ í•­ëª©ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ ë°°ê²½ ê°•ì¡° ìƒ‰ìƒ */
    .sidebar .menu-item:hover {
      background-color: #f0f0f0;
    }

    /* ë‹¤í¬ ëª¨ë“œì—ì„œ ë©”ë‰´ í•­ëª©ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ ë°°ê²½ê³¼ ê¸€ì”¨ ê°•ì¡° ìƒ‰ìƒ */
    .dark-mode .sidebar .menu-item:hover {
      background-color: #444;
      color: #fff;
    }
  </style>
</head>

<body>
  <!-- ğŸ‘¤ ë°±ì¤€ ì•„ì´ë”” ì…ë ¥ í™”ë©´ -->
  <div class="intro-container" id="intro-page">
    <h2>ğŸ‘‹ ë°±ì¤€ ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”</h2>
    <input type="text" id="boj-username" placeholder="ex joonas123" style="padding: 10px; font-size: 16px;" />
    <br /><br />
    <button onclick="startChat()" style="padding: 10px 20px; font-size: 16px;">ì‹œì‘í•˜ê¸°</button>
  </div>

  <!-- ğŸ¤– ì±—ë´‡ í™”ë©´ -->
  <div class="container" id="chat-page" style="display: none;">
    <div class="menu-button" onclick="toggleSidebar()">&#9776;</div>

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar" id="sidebar">
      <div class="menu-item" onclick="clearChat()">ğŸ“„ ìƒˆ ì±„íŒ…</div>
      <div class="menu-item" onclick="openPromptSettings()">ğŸ§  í”„ë¡¬í”„íŠ¸ ì„¤ì •</div>
      <div class="menu-item" onclick="openSettings()">âš™ ì„¤ì •</div>
    </div>

    <!-- ì„¤ì • í˜ì´ì§€ -->
    <div class="settings-page" id="settings-page" style="display: none;">
      <div class="settings-header" id="settings-header">
        <span>âš™ ì„¤ì •</span>
        <div class="window-controls">
          <button class="close-btn" onclick="closeSettings()">X</button>
        </div>
      </div>
      <div class="menu-item" onclick="toggleStylePopup()">ğŸ¹ í‚¤ë³´ë“œ</div>
      <div id="style-popup" style="display:none; position:fixed; top:60%; left:50%;
        background:white; padding:15px; border:1px solid #ccc; border-radius:10px;
        box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1001; min-width: 260px;">
        <!-- ğŸ”§ í—¤ë” ì˜ì—­ -->
        <div class="popup-header" id="popup-drag-header"
          style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: move;">
          <strong class="popup-title">ğŸ’¡ ê¸€ì”¨ í¬ê¸° ë³€ê²½</strong>
          <button onclick="closeStylePopup()"
            style="background:none; border:none; font-size: 16px; cursor:pointer;">âŒ</button>
        </div>
        <!-- ë²„íŠ¼ ì˜ì—­ -->
        <div class="button-group">
          <button class="font-button" onclick="setFontSize('small')">ì‘ê²Œ</button>
          <button class="font-button" onclick="setFontSize('medium')">ë³´í†µ</button>
          <button class="font-button" onclick="setFontSize('large')">í¬ê²Œ</button>
        </div>
      </div>
      <label><input type="checkbox" id="dark-mode-toggle" /> ë‹¤í¬ ëª¨ë“œ í™œì„±í™”</label><br />
      <button onclick="saveChatHistory()">ğŸ’¾ ì±„íŒ… ì €ì¥</button>
      <button onclick="loadChatHistory()">ğŸ“‚ ì±„íŒ… ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>

    <!-- ì±„íŒ…ì°½ -->
    <div class="chat-container">
      <div class="chat-box" id="chat-box"></div>
      <textarea class="input-box" id="input-box" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”." rows="3"></textarea>
      <button class="send-button" onclick="sendMessage()">ì „ì†¡</button>
    </div>

    <!-- âœ… web.html ìˆ˜ì • ë‚´ìš© ì „ì²´
<!-- âœ… ì‚¬ì´ë“œë°”ì— í”„ë¡¬í”„íŠ¸ ì„¤ì • ë©”ë‰´ ì¶”ê°€ -->
    <!-- âœ… í”„ë¡¬í”„íŠ¸ ì„¤ì • ëª¨ë‹¬ -->
    <div class="modal" id="promptModal"
      style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000;">
      <div class="modal-content"
        style="background:white; padding:20px; max-width:500px; margin:100px auto; border-radius:12px; position:relative;">
        <span class="close" onclick="closePromptSettings()"
          style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:18px;">âŒ</span>
        <h3>ğŸ§  ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ ì„¤ì •</h3>
        <textarea id="custom-prompt" rows="4" style="width: 100%; margin-bottom: 10px;"></textarea>
        <button onclick="saveCustomPrompt()">ğŸ’¾ ì €ì¥</button>
        <button onclick="viewPromptHistory()">ğŸ•˜ ê¸°ë¡ ë³´ê¸°</button>
        <div id="prompt-history" style="margin-top: 10px; font-size: 14px; color: #444;"></div>
      </div>
    </div>

    <script>
      // âœ… í”„ë¡¬í”„íŠ¸ ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
      function openPromptSettings() {
        document.getElementById("promptModal").style.display = "block";
        document.getElementById("custom-prompt").value = localStorage.getItem("customPrompt") || "";
        viewPromptHistory(); // ì—´ë¦´ ë•Œ ê¸°ë¡ë„ ê°™ì´ ë³´ì—¬ì¤Œ
      }

      // âœ… í”„ë¡¬í”„íŠ¸ ì„¤ì • ëª¨ë‹¬ ë‹«ê¸°
      function closePromptSettings() {
        document.getElementById("promptModal").style.display = "none";
      }

      // âœ… í”„ë¡¬í”„íŠ¸ ì €ì¥
      function saveCustomPrompt() {
        const value = document.getElementById("custom-prompt").value.trim();
        if (!value) return alert("í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
        localStorage.setItem("customPrompt", value);

        // í”„ë¡¬í”„íŠ¸ ê¸°ë¡ ì¶”ê°€
        const history = JSON.parse(localStorage.getItem("promptHistory") || "[]");
        history.push({ value, date: new Date().toLocaleString() });
        localStorage.setItem("promptHistory", JSON.stringify(history));

        alert("í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
        viewPromptHistory(); // ì €ì¥ í›„ ê°±ì‹ 
      }

      // âœ… í”„ë¡¬í”„íŠ¸ ê¸°ë¡ ë³´ê¸° ë° ì‚­ì œ ê°€ëŠ¥
      function viewPromptHistory() {
        const history = JSON.parse(localStorage.getItem("promptHistory") || "[]");
        const container = document.getElementById("prompt-history");
        if (history.length === 0) {
          container.innerHTML = "<p>ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
          return;
        }
        container.innerHTML = history.map((h, i) => `
      <div style="margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 6px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>ğŸ•˜ ${h.date}</strong>
          <button onclick="deletePrompt(${i})" style="background:#f44336; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">ì‚­ì œ</button>
        </div>
        <div style="margin-top: 4px; white-space: pre-wrap;">${h.value}</div>
      </div>
    `).join("");
      }

      // âœ… í”„ë¡¬í”„íŠ¸ ê¸°ë¡ ì‚­ì œ
      function deletePrompt(index) {
        let history = JSON.parse(localStorage.getItem("promptHistory") || "[]");
        if (!confirm("ì´ í”„ë¡¬í”„íŠ¸ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;
        history.splice(index, 1);
        localStorage.setItem("promptHistory", JSON.stringify(history));
        viewPromptHistory(); // ë‹¤ì‹œ ê·¸ë ¤ì¤Œ
      }
    </script>

    <!-- ë°ì¼ë¦¬ ëª©í‘œ ëª¨ë‹¬ -->
    <div id="dailyGoalModal" class="modal"
      style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000;">
      <div
        style="background:white; padding:20px; max-width:400px; margin:100px auto; border-radius:12px; position:relative;">
        <span onclick="closeDailyGoalModal()"
          style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:18px;">âŒ</span>
        <h3 style="margin-top:10px; margin-bottom:20px;">ğŸ¯ ë°ì¼ë¦¬ ëª©í‘œ ì„¤ì •</h3>

        <label for="goalInput">ëª©í‘œ ë¬¸ì œ ìˆ˜:</label>
        <input type="number" id="goalInput" min="1" style="width: 80px; margin: 8px 0;"><br>
        <button onclick="setDailyGoal()">ëª©í‘œ ì„¤ì •</button>

        <div id="progress-area"
          style="margin-top: 20px; display: none; text-align: center; position: relative; z-index: 10;">
          <p
            style="font-size: 16px; font-weight: bold; margin: 0; text-align: center; padding-right: 20px; position: relative;">
            í˜„ì¬ í‘¼ ë¬¸ì œ ìˆ˜:
            <span id="solvedCount" style="font-weight: bold; position: static;">0</span> /
            <span id="goalCount" style="color: #2c3e50; position: static; display: inline;">0</span>
          </p>
          <div style="background-color: #eee; border-radius: 6px; overflow: hidden; height: 20px; margin-top: 10px;">
            <div id="progressBar" style="height: 100%; width: 0%; background-color: #4CAF50;"></div>
          </div>
          <div style="margin-top: 10px; text-align: center;">
            <button onclick="changeSolvedCount(1)">+1</button>
            <button onclick="changeSolvedCount(-1)">-1</button>
            <button onclick="resetGoal()">ëª©í‘œ ì´ˆê¸°í™”</button>
          </div>
          <div id="congratsMessage"
            style="display:none; text-align:center; color:green; font-weight:bold; font-size:18px; margin-top:10px;">
            ğŸ‰ ëª©í‘œ ë‹¬ì„±! ğŸ‰
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function startChat() {
      const username = document.getElementById('boj-username').value.trim();
      if (!username) {
        alert('ë°±ì¤€ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }
      localStorage.setItem('bojUsername', username);
      document.getElementById('intro-page').style.display = 'none';
      document.getElementById('chat-page').style.display = 'flex';

      displayMessage(`${username}ë‹˜, ë¬´ì—‡ì„ ë¶„ì„í•´ ë“œë¦´ê¹Œìš”?`, 'bot-message');
      showMainOptions();
    }

    async function sendMessage(skipUserMessage = false) {
      const inputBox = document.getElementById('input-box');
      const fileInput = document.getElementById('file-input');
      const message = inputBox.value.trim();
      const bojUsername = localStorage.getItem('bojUsername') || "";

      if (!message) return;

      if (!skipUserMessage) {
        displayMessage(message, 'user-message');
      }

      inputBox.value = '';

      const formData = new FormData();
      formData.append('question', message);
      formData.append('boj_username', bojUsername);
      formData.append('prompt', localStorage.getItem("customPrompt") || "");  // âœ… í”„ë¡¬í”„íŠ¸ í¬í•¨

      const url = fileInput && fileInput.files && fileInput.files.length > 0
        ? 'http://127.0.0.1:8000/analyze'
        : 'http://127.0.0.1:8000/chat';

      try {
        const response = await fetch(url, { method: 'POST', body: formData });
        const data = await response.json();
        displayMessage(data.summary || data.answer || "ì˜¤ë¥˜ ë°œìƒ", 'bot-message');
      } catch (error) {
        displayMessage("âš  ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ", 'bot-message');
      }
    }


    function displayMessage(msg, className) {
      const chatBox = document.getElementById('chat-box');
      const div = document.createElement('div');
      div.className = `message ${className}`;
      div.innerHTML = msg;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    document.getElementById('input-box').addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    document.getElementById('dark-mode-toggle').addEventListener('change', function () {
      document.body.classList.toggle('dark-mode', this.checked);
      localStorage.setItem('darkMode', this.checked);
    });

    window.onload = function () {
      const savedDark = localStorage.getItem('darkMode') === 'true';
      document.body.classList.toggle('dark-mode', savedDark);
      document.getElementById('dark-mode-toggle').checked = savedDark;
    };

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    function clearChat() {
      document.getElementById('chat-box').innerHTML = '<div class="message bot-message">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>';
      showMainOptions(); // ìƒˆ ì±„íŒ… ì‹œ ë‹¤ì‹œ ë²„íŠ¼ ë³´ì—¬ì¤Œ
    }

    function openSettings() {
      document.getElementById('settings-page').style.display = 'block';
    }

    function closeSettings() {
      document.getElementById('settings-page').style.display = 'none';
    }

    function toggleStylePopup() {
      const popup = document.getElementById("style-popup");
      popup.style.display = popup.style.display === "none" ? "block" : "none";
    }

    function setFontSize(size) {
      const messages = document.querySelectorAll('.bot-message, .user-message');
      messages.forEach(msg => {
        msg.classList.remove('size-small', 'size-medium', 'size-large');
        msg.classList.add(`size-${size}`);
      });
    }

    function saveChatHistory() {
      localStorage.setItem('chatHistory', document.getElementById('chat-box').innerHTML);
      alert('ì±„íŒ…ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    function loadChatHistory() {
      const savedChat = localStorage.getItem('chatHistory');
      if (savedChat) {
        document.getElementById('chat-box').innerHTML = savedChat;
      } else {
        alert('ì €ì¥ëœ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.');
      }
    }

    // âœ… ë¶„ì„ ë²„íŠ¼ UI ì¶œë ¥
    function showMainOptions() {
      const chatBox = document.getElementById('chat-box');

      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'button-container';
      buttonContainer.style.marginTop = '15px';
      buttonContainer.style.marginBottom = '15px';


      const buttons = [
        { label: 'ğŸ‘¤ ë‚´ ë°±ì¤€ ì •ë³´ ë³´ê¸°', message: 'ë‚´ ë°±ì¤€ ì •ë³´ ë³´ê¸°' },
        { label: 'ğŸ“… ì£¼ê°„ í™œë™ ë³´ê¸°', message: 'ì£¼ê°„ í™œë™ ë³´ê¸°' },
        { label: 'ğŸ“Š í’€ì´ ë¶„í¬ ë³´ê¸°', message: 'í’€ì´ ë¶„í¬ ë³´ê¸°' },
        { label: 'ğŸ“ˆ ë‚œì´ë„ ì¶”ì„¸', message: 'ë‚œì´ë„ ì¶”ì„¸' },
        { label: 'ğŸ“ˆ ë“±ê¸‰ ë³„ ê³µë¶€ë²•', message: 'ë“±ê¸‰ ë³„ ê³µë¶€ë²•' },
        { label: 'ğŸ† ë„ì „ ê³¼ì œ ìƒì„±', message: 'ë„ì „ ê³¼ì œ ìƒì„±' },
        { label: 'ğŸ¤– AI ë¬¸ì œ ì¶”ì²œ', message: 'AIë¬¸ì œ ì¶”ì²œ' },
        { label: 'ğŸ… í‹°ì–´ ì²´í—˜í•˜ê¸°', message: 'í‹°ì–´ ì²´í—˜' },
        { label: 'ğŸ§  ë¬¸ì œ í’€ì´ ì „ëµ ë°›ê¸°', message: 'ë¬¸ì œ í’€ì´ ì „ëµ' },
        { label: 'ğŸ¥‡ í‹°ì–´ ì¸ê¸° ë¬¸ì œ ì¶”ì²œ', message: 'í‹°ì–´ ì¸ê¸° ë¬¸ì œ ì¶”ì²œ' },
        { label: 'ğŸ¯ ë°ì¼ë¦¬ ëª©í‘œ ì„¤ì •', action: showDailyGoalModal }
      ];

      buttons.forEach(btn => {
        const button = document.createElement('button');
        button.textContent = btn.label;
        button.className = 'chat-button';  // ë²„íŠ¼ì— í´ë˜ìŠ¤ ì¶”ê°€

        // ë²„íŠ¼ í´ë¦­ ì‹œ action ì‹¤í–‰
        button.onclick = () => {
          if (btn.action) {
            // actionì´ ìˆì„ ê²½ìš° í•´ë‹¹ í•¨ìˆ˜ë¥¼ ì‹¤í–‰ (ëª¨ë‹¬ ì—´ê¸° ë“±)
            btn.action();  // openGoalModal() ì‹¤í–‰
          } else {
            // actionì´ ì—†ì„ ê²½ìš° ì›ë˜ëŒ€ë¡œ ë©”ì‹œì§€ ì²˜ë¦¬
            displayMessage(` ${btn.label}`, 'user-message');
            sendAutoMessage(btn.message);
          }
        };

        // ë²„íŠ¼ì„ ë²„íŠ¼ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
        buttonContainer.appendChild(button);
      });

      chatBox.appendChild(buttonContainer);
      chatBox.scrollTop = chatBox.scrollHeight;

    }

    // âœ… ë²„íŠ¼ í´ë¦­ ì‹œ ìë™ ë©”ì‹œì§€ ì „ì†¡ 
    function sendAutoMessage(message) {
      const inputBox = document.getElementById('input-box');
      inputBox.value = message;

      if (message === "ë‚´ ë°±ì¤€ ì •ë³´ ë³´ê¸°") {
        const username = localStorage.getItem('bojUsername');
        if (username) {
          fetchUserInfo(username);
        } else {
          displayMessage("âš  ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'bot-message');
        }
      } else if (message === "AIë¬¸ì œ ì¶”ì²œ") {
        recommendProblem();  // ëœë¤ ë¬¸ì œ ì¶”ì²œ ì‹œ recommendProblem í˜¸ì¶œ
      } else if (message === "í’€ì´ ë¶„í¬ ë³´ê¸°") {
        showDistribution();
      } else if (message === "ë„ì „ ê³¼ì œ ìƒì„±") {
        generateChallenge();  // ìƒˆ í•¨ìˆ˜ í˜¸ì¶œ
      } else if (message === "í‹°ì–´ ì²´í—˜") {
        generateTierExperience();
      } else if (message === "ì£¼ê°„ í™œë™ ë³´ê¸°") {
        showWeeklyChart();
      }  else if (message === "í‹°ì–´ ì¸ê¸° ë¬¸ì œ ì¶”ì²œ") { 
        fetchPopularProblems(); 
      } else if (message === "ë“±ê¸‰ ë³„ ê³µë¶€ë²•") {
        getRankUpTip();
      } else if (message === "ë¬¸ì œ í’€ì´ ì „ëµ") {
        const pid = prompt("ë¬¸ì œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1000):");
        if (pid) fetchProblemFeedback(pid);
      } else {
        sendMessage(true);
      }

    }

    function closeStylePopup() {
      document.getElementById("style-popup").style.display = "none";
    }

    // ë‚´ì •ë³´
    async function fetchUserInfo(username) {
      try {
        const res = await fetch(`http://127.0.0.1:8000/userinfo?boj_username=${username}`);
        const data = await res.json();
        if (data.error) {
          alert(data.error);
        } else {

          const tierMap = [
            "Unrated",
            "Bronze V", "Bronze IV", "Bronze III", "Bronze II", "Bronze I",
            "Silver V", "Silver IV", "Silver III", "Silver II", "Silver I",
            "Gold V", "Gold IV", "Gold III", "Gold II", "Gold I",
            "Platinum V", "Platinum IV", "Platinum III", "Platinum II", "Platinum I",
            "Diamond V", "Diamond IV", "Diamond III", "Diamond II", "Diamond I",
            "Ruby V", "Ruby IV", "Ruby III", "Ruby II", "Ruby I",
            "Master", "Grandmaster", "Challenger"
          ];
          const userTierName = tierMap[data.tier] || "Unknown";

          const cardHTML = `
          <div class="boj-card">
            <div class="boj-card-header">ğŸ‘¤ ${username}ë‹˜ì˜ ë°±ì¤€ ì •ë³´</div>
            <div class="boj-info-grid">
              <div class="info-item">ğŸ– í‹°ì–´:<strong>${userTierName}</strong></div>
              <div class="info-item">ğŸ“ˆ ë­í‚¹:<strong>${data.rank}</strong></div>
              <div class="info-item">âœ… í‘¼ ë¬¸ì œ ìˆ˜:<strong>${data.solved_count}</strong></div>
              <div class="info-item">ğŸ« í´ë˜ìŠ¤:<strong>${data.class}</strong></div>
              <div class="info-item">ğŸ”¥ ìµœì¥ ìŠ¤íŠ¸ë¦­:<strong>${data.max_streak}</strong></div>
              <div class="info-item">ğŸ“Š ì‹¤ë ¥ ì ìˆ˜:<strong>${data.rating}</strong></div>
            </div>
          </div>
        `;
          displayMessage(cardHTML, 'bot-message');  // HTML ì¶œë ¥ í•¨ìˆ˜
        }
      } catch (e) {
        displayMessage("âš  ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", 'bot-message');
      }
    }
    // ëœë¤ë¬¸ì œì¶”ì²œ
    async function recommendProblem() {
      const bojUsername = localStorage.getItem('bojUsername');
      if (!bojUsername) {
        displayMessage("âš  ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.", 'bot-message');
        return;
      }

      try {
        // const res = await fetch(`http://127.0.0.1:8000/recommend?boj_username=${bojUsername}`);
        const res = await fetch(`http://127.0.0.1:8000/recommend?boj_username=${bojUsername}`);

        const data = await res.json();


        if (data.error) {
          displayMessage(data.error, 'bot-message');
        } else {
          const problemLink = `https://www.acmicpc.net/problem/${data.problemId}`;
          const tierImageUrl = `https://static.solved.ac/tier_small/${data.tier}.svg`;

          const cardHtml = `
        <div style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #ffffff;
          border-radius: 12px;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
          padding: 16px;
          margin: 18px 0;
          max-width: 640px;
        ">
          <div style="flex: 1; padding-right: 16px;">
            <h3 style="margin: 0 0 8px 0; font-size: 18px;">ğŸ§  ${data.title}</h3>
            <p style="margin: 2px 0;">ğŸ“Œ ë¬¸ì œ ë²ˆí˜¸: <strong>${data.problemId}</strong></p>
            <p style="margin: 2px 0;">â­ í‹°ì–´: ${data.tierName}</p>
            <p style="margin: 6px 0; color: #444; font-size: 13.5px; line-height: 1.4;"> í‹°ì–´ì— ë§ê²Œ ëœë¤ìœ¼ë¡œ ë¬¸ì œë¥¼ ì¶”ì²œí•´ì¤ë‹ˆë‹¤.</p>
            <a href="${problemLink}" target="_blank" style="
              display: inline-block;
              margin-top: 6px;
              padding: 6px 12px;
              background-color: #4CAF50;
              color: white;
              border-radius: 16px;
              text-decoration: none;
              font-weight: bold;
              font-size: 14px;
              transition: background 0.3s;
            " onmouseover="this.style.backgroundColor='#45a049'" onmouseout="this.style.backgroundColor='#4CAF50'"> ğŸ‘‰ ë¬¸ì œ í’€ëŸ¬ ê°€ê¸°
            </a>
          </div>
          <div style="flex-shrink: 0;">
            <img src="${tierImageUrl}" alt="í‹°ì–´" style="width: 64px; height: 64px;" />
          </div>
        </div>
      `;

          const chatBox = document.getElementById("chat-box");
          const div = document.createElement("div");
          div.className = "message bot-message";
          div.innerHTML = cardHtml;
          chatBox.appendChild(div);
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      } catch (error) {
        displayMessage("âš  ì¶”ì²œ ë¬¸ì œë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'bot-message');
      }
    }

    let chartInstance = null;  // ì „ì—­ìœ¼ë¡œ Chart ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì €ì¥

    async function showDistribution() {
      const bojUsername = localStorage.getItem('bojUsername');
      if (!bojUsername) {
        displayMessage("âš  ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.", 'bot-message');
        return;
      }

      try {
        const res = await fetch(`http://127.0.0.1:8000/distribution?boj_username=${bojUsername}`);
        const data = await res.json();

        if (data.error) {
          displayMessage(data.error, 'bot-message');
          return;
        }

        // âœ… ìˆ˜ì •ëœ ë¶€ë¶„: ë°±ì—”ë“œ ì‘ë‹µ ë°ì´í„° í•„ë“œ ì •í™•íˆ ë§ì¶¤
        const levels = data.levels;
        const counts = data.counts;

        console.log("ğŸ“Š levels", levels);
        console.log("ğŸ“Š counts", counts);

        const canvasId = 'difficulty-chart';
        const chartHtml = `
      <div style="max-width: 500px; margin-top: 16px;">
        <h4>ğŸ“Š ë‚œì´ë„ ë³„ í’€ì´ ë¶„í¬</h4>
        <canvas id="${canvasId}" width="400" height="300"></canvas>
      </div>
    `;
        displayMessage(chartHtml, 'bot-message');

        // DOM ê·¸ë ¤ì§„ ë‹¤ìŒ ì•ˆì „í•˜ê²Œ ì‹¤í–‰
        setTimeout(() => {
          const ctx = document.getElementById(canvasId)?.getContext('2d');
          if (!ctx) {
            console.error("ğŸ¯ canvasë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          // ì´ì „ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì œê±°
          if (chartInstance !== null) {
            chartInstance.destroy();
          }

          chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: levels,
              datasets: [{
                label: 'í’€ì´í•œ ë¬¸ì œ ìˆ˜',
                data: counts,
                backgroundColor: '#4CAF50',
                borderRadius: 8,
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  beginAtZero: true,
                  // âœ… ì—¬ê¸° ì¶”ê°€: ìµœëŒ€ê°’ ì„¤ì • (ìë™ ìµœëŒ€ê°’ì´ ë„ˆë¬´ ì‘ì„ ë•Œ ëŒ€ë¹„)
                  suggestedMax: Math.max(...counts) + 10,  // ìµœëŒ“ê°’ + ì—¬ìœ 
                  ticks: {
                    stepSize: 1
                  }
                }
              }
            }
          });


        }, 150);  // DOM ìƒì„± ëŒ€ê¸° ì‹œê°„

      } catch (err) {
        displayMessage("âš  ë¶„í¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", 'bot-message');
      }
    }

    //í‹°ì–´ì²´í—˜
    async function generateTierExperience() {
      console.log("âœ… í‹°ì–´ ì²´í—˜ í•¨ìˆ˜ í˜¸ì¶œë¨");

      const randomTier = Math.floor(Math.random() * (30 - 16 + 1)) + 16;

      const res = await fetch(`http://127.0.0.1:8000/tier_experience?tier=${randomTier}`);
      const data = await res.json();

      if (data.error) {
        displayMessage("âš  í‹°ì–´ ì²´í—˜ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "bot-message");
        return;
      }

      const div = document.createElement("div");
      div.className = "message bot-message";

      let html = `
        <div style="background: #f0f8ff; border-radius: 12px; padding: 20px;
                    margin: 20px 0; max-width: 640px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
          <h3 style="margin: 0 0 20px; color: #3558a2;">ğŸ… ${data.tier_name} í‹°ì–´ ì²´í—˜í•´ë³´ê¸°</h3>
      `;

      data.problems.forEach((p, i) => {
        html += `
          <div style="display: flex; justify-content: space-between; align-items: center;
                      background-color: #ffffff; border: 1.5px solid #d0d8e8;
                      border-radius: 10px; padding: 14px 18px; margin-bottom: 12px;
                      box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: transform 0.2s;"
              onmouseover="this.style.transform='scale(1.01)'" 
              onmouseout="this.style.transform='scale(1)'">
            <div style="font-size: 15px; font-weight: 600; color: #333;text-align: left; flex: 1;">
              ${i + 1}. ${p.title}
            </div>
            <a href="${p.url}" target="_blank" style="
              padding: 6px 10px; background: #4e83f1; color: white;
              text-decoration: none; border-radius: 6px; font-size: 13px;
              font-weight: 500;">
              ë¬¸ì œ í’€ê¸° ğŸ”—
            </a>
          </div>
        `;
      });

      html += "</div>";
      div.innerHTML = html;
      document.getElementById("chat-box").appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }


    // ë„ì „ ê³¼ì œ ìƒì„±
    async function generateChallenge() {
      const bojUsername = localStorage.getItem('bojUsername');
      if (!bojUsername) {
        displayMessage("âš  ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.", 'bot-message');
        return;
      }

      const res = await fetch(`http://127.0.0.1:8000/challenge?boj_username=${bojUsername}`);
      const data = await res.json();

      console.log(data);

      if (data.error) {
        displayMessage(data.error, 'bot-message');
        return;
      }

      const div = document.createElement("div");
      div.className = "message bot-message";
      div.innerHTML = data.challenge;
      document.getElementById("chat-box").appendChild(div);

      // ğŸ”½ ì¹´ë“œ HTML êµ¬ì„±
      let html = `
        <div style="background: #ffffff; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 16px; margin: 18px 0; max-width: 640px;">
          <h3 style="margin-bottom: 10px;">ğŸ¯ ${data.title}</h3>
          <p style="margin: 6px 0;"> ë‹¤ìŒ í‹°ì–´ë¥¼ í–¥í•´ ë„ì „í•´ë³´ì„¸ìš”!</p>
      `;

      data.problems.forEach((p, i) => {
        html += `
          <a href="https://www.acmicpc.net/problem/${p.id}" target="_blank" style="
            display: block;
            margin: 8px 0;
            padding: 14px 16px;
            background-color: #ffffff;
            border: 1.5px solid #ddd;
            border-radius: 10px;
            text-decoration: none;
            color: #222;
            font-weight: 600;
            transition: background 0.2s;, transform 0.1s;
          " onmouseover="this.style.backgroundColor='#f0f0f0'; this.style.transform='scale(1.01)'"
            onmouseout="this.style.backgroundColor='#ffffff'; this.style.transform='scale(1)'">
            ${i + 1}. ${p.title}
          </a>
        `;
      });

      html += `</div>`;
      div.innerHTML = html;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // í•œì£¼ê¸°ë¡ ì‹œê°í™”
    async function showWeeklyChart() {
      const bojUsername = localStorage.getItem('bojUsername');
      if (!bojUsername) {
        displayMessage("âš  ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.", 'bot-message');
        return;
      }

      const res = await fetch(`http://127.0.0.1:8000/weekly_activity?boj_username=${bojUsername}`);
      const data = await res.json();

      if (data.error) {
        displayMessage(data.error, 'bot-message');
        return;
      }

      const canvasId = 'weekly-chart';
      const chartHtml = `
    <div style="max-width: 500px; margin-top: 16px;">
      <h4>ğŸ“† ì´ë²ˆ ì£¼ í’€ì´ í˜„í™©</h4>
      <canvas id="${canvasId}" width="400" height="300"></canvas>
    </div>
  `;
      displayMessage(chartHtml, 'bot-message');

      setTimeout(() => {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (chartInstance !== null) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.days,
            datasets: [{
              label: 'í‘¼ ë¬¸ì œ ìˆ˜',
              data: data.counts,
              backgroundColor: '#337ab7',
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              y: {
                beginAtZero: true,
                suggestedMax: Math.max(...data.counts) + 3,
                ticks: { stepSize: 1 }
              }
            }
          }
        });
      }, 150);
    }


    const settingsPage = document.getElementById("settings-page");
    const settingsHeader = document.getElementById("settings-header");

    let draggingSettings = false;
    let offsetX_settings = 0;
    let offsetY_settings = 0;

    settingsHeader.addEventListener("mousedown", function (e) {
      // ì„¤ì •ì°½ì˜ í˜„ì¬ ìœ„ì¹˜ë¥¼ ì‹¤ì œ ì¢Œí‘œë¡œ ê³„ì‚°
      const rect = settingsPage.getBoundingClientRect();

      // transformì„ ì—†ì• ê³  í˜„ì¬ ìœ„ì¹˜ë¥¼ top/leftë¡œ ê³ ì •
      settingsPage.style.left = `${rect.left}px`;
      settingsPage.style.top = `${rect.top}px`;
      settingsPage.style.transform = "none"; // ì¤‘ìš”!!

      offsetX_settings = e.clientX - rect.left;
      offsetY_settings = e.clientY - rect.top;
      draggingSettings = true;
    });

    document.addEventListener("mousemove", function (e) {
      if (!draggingSettings) return;

      const x = e.clientX - offsetX_settings;
      const y = e.clientY - offsetY_settings;

      settingsPage.style.left = `${x}px`;
      settingsPage.style.top = `${y}px`;
    });

    document.addEventListener("mouseup", function () {
      draggingSettings = false;
    });


    function saveGoal() {
      // ëª©í‘œ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
      const goalInput = document.getElementById('goalInput');
      let dailyGoal = parseInt(goalInput.value);

      // ëª©í‘œ ìˆ˜ê°€ ì œëŒ€ë¡œ ì…ë ¥ë˜ì—ˆëŠ”ì§€ í™•ì¸
      if (isNaN(dailyGoal) || dailyGoal <= 0) {
        alert("ëª©í‘œ ë¬¸ì œ ìˆ˜ë¥¼ ì œëŒ€ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      // ëª©í‘œ ìˆ˜ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ ë©”ì‹œì§€ í‘œì‹œ
      const goalSavedMessage = document.getElementById('goal-saved-message');
      goalSavedMessage.style.display = 'block';  // ë©”ì‹œì§€ ë³´ì´ê¸°

      // 1ì´ˆ í›„ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
      setTimeout(() => {
        goalSavedMessage.style.display = 'none';
      }, 1000);

      // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ (ì—¬ê¸°ì„œ ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸)
      updateProgressBar();

      console.log("ğŸ¯ ëª©í‘œ ì„¤ì • ì™„ë£Œ! ëª©í‘œ ìˆ˜:", dailyGoal);
    }

    // +1, -1 ë²„íŠ¼ìœ¼ë¡œ í‘¼ ë¬¸ì œ ìˆ˜ ì¡°ì •
    function adjustSolvedCount(amount) {
      const current = parseInt(localStorage.getItem('solvedCount') || '0');
      let updated = current + amount;
      if (updated < 0) updated = 0;

      localStorage.setItem('solvedCount', updated);
      updateProgressBar();
      document.getElementById('solvedCountDisplay').textContent = updated;


      // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
      updateProgressBar();
    }

    function updateSolvedCount(newSolvedCount) {
      solvedCount = newSolvedCount;
      const goal = parseInt(localStorage.getItem('dailyGoal') || 0);
      updateProgressBar(goal, solvedCount);
    }

    // ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateProgressBar(goal, solved) {
      const progressBar = document.getElementById('progress-bar');
      const progressBarContainer = document.getElementById('progress-bar-container');

      if (goal === 0) {
        progressBar.style.width = '0%';
      } else {
        const percentage = (solved / goal) * 100;
        progressBar.style.width = percentage + '%';
      }

      // ì§„í–‰ë¥  ë°”ë¥¼ í™”ë©´ì— í‘œì‹œ
      progressBarContainer.style.display = 'block';
    }

    // ë°ì¼ë¦¬ ëª©í‘œ ì„¤ì • íŒì—… ì—´ê¸°
    function openGoalModal() {
      const goalModal = document.getElementById('goalModal');
      goalModal.style.display = 'block';  // íŒì—… í‘œì‹œ

      // í‘¼ ë¬¸ì œ ìˆ˜ í‘œì‹œ ì—…ë°ì´íŠ¸
      const solved = localStorage.getItem('solvedCount') || '0';
      document.getElementById('solvedCountDisplay').textContent = solved;
    }

    // ë°ì¼ë¦¬ ëª©í‘œ ì„¤ì • íŒì—… ë‹«ê¸°
    function closeGoalModal() {
      const goalModal = document.getElementById('goalModal');
      goalModal.style.display = 'none';  // íŒì—… ìˆ¨ê¸°ê¸°
    }


    // ë“±ê¸‰ì—… ì „ëµ ë³´ì—¬ì£¼ê¸°
    async function getRankUpTip() {
      const bojUsername = localStorage.getItem('bojUsername');
      if (!bojUsername) {
        displayMessage("âš  ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.", 'bot-message');
        return;
      }

      const res = await fetch(`http://127.0.0.1:8000/rankup_tip?boj_username=${bojUsername}`);
      const data = await res.json();

      if (data.error) {
        displayMessage(data.error, 'bot-message');
      } else {
        const rankUpTipHtml = `
          <div style="max-width: 500px; margin-top: 16px; padding: 16px; border-radius: 12px; background-color: #ffffff; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
            <div style="display: flex; align-items: center; margin-bottom: 12px;">
              <span style="font-size: 32px; margin-right: 12px;">ğŸ“ˆ</span>
              <h4 style="margin: 0; font-size: 20px; color: #6C9D6F;">ë“±ê¸‰ ì—… TipğŸ’¡</h4>
            </div>
            <div style="font-size: 18px; color: #333; padding-left: 12px; padding-right: 12px; text-align: center;">
              <p style="font-weight: bold; font-size: 22px;">${data.tip}</p>
            </div>
            <div style="text-align: center;">
            </div>
          </div>
        `;
        displayMessage(rankUpTipHtml, 'bot-message');
      }
    }

    let dailyGoal = 0; // ëª©í‘œ ë¬¸ì œ ìˆ˜
    let solvedCount = 0; // í‘¼ ë¬¸ì œ ìˆ˜

    // ëª©í‘œ ì„¤ì • ì €ì¥ í•¨ìˆ˜
    function saveGoal() {
      const goalInput = document.getElementById('goalInput').value;

      // ëª©í‘œ ë¬¸ì œ ìˆ˜ ì„¤ì •
      dailyGoal = parseInt(goalInput);

      if (isNaN(dailyGoal) || dailyGoal <= 0) {
        alert("ëª©í‘œ ë¬¸ì œ ìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
      updateProgress();

      // ëª¨ë‹¬ ë‹«ê¸°
      closeGoalModal();
    }

    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateProgress() {
      // í‘¼ ë¬¸ì œ ìˆ˜ì™€ ëª©í‘œ ë¬¸ì œ ìˆ˜ì— ë”°ë¼ ì§„í–‰ë¥  ê³„ì‚°
      const progress = (solvedCount / dailyGoal) * 100;

      // ì§„í–‰ë¥  ë°”ì™€ í˜„ì¬ í‘¼ ë¬¸ì œ ìˆ˜ ì—…ë°ì´íŠ¸
      document.getElementById('goal-progress-bar').style.width = `${progress}%`;
      document.getElementById('solved-count').textContent = solvedCount;
    }

    // í‘¼ ë¬¸ì œ ìˆ˜ +1 ë²„íŠ¼ í•¨ìˆ˜
    function incrementSolvedCount() {
      solvedCount++;
      updateProgress();
    }

    // í‘¼ ë¬¸ì œ ìˆ˜ -1 ë²„íŠ¼ í•¨ìˆ˜
    function decrementSolvedCount() {
      if (solvedCount > 0) {
        solvedCount--;
        updateProgress();
      }
    }

    // ëª©í‘œ ìˆ˜ì • í•¨ìˆ˜
    function editGoal() {
      const newGoal = prompt("ìƒˆë¡œìš´ ëª©í‘œë¥¼ ì„¤ì •í•˜ì„¸ìš”:");
      if (newGoal && !isNaN(newGoal) && newGoal > 0) {
        localStorage.setItem('dailyGoal', newGoal);
        alert(`ëª©í‘œê°€ ${newGoal}ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        updateProgressBar(newGoal, solvedCount);  // ìˆ˜ì •ëœ ëª©í‘œë¡œ ì§„í–‰ë¥  ë°” ê°±ì‹ 
      } else {
        alert("ìœ íš¨í•œ ëª©í‘œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      }
    }

    // ëª©í‘œ ì‚­ì œ í•¨ìˆ˜
    function deleteGoal() {
      localStorage.removeItem('dailyGoal');
      alert("ëª©í‘œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      updateProgressBar(0, 0);  // ëª©í‘œ ì‚­ì œ í›„ ì§„í–‰ë¥  ë°” ì´ˆê¸°í™”
      document.getElementById('goal-actions').style.display = 'none';
    }

    window.onload = function () {
      const savedGoal = localStorage.getItem('dailyGoal');
      if (savedGoal) {
        const goal = parseInt(savedGoal);
        updateProgressBar(goal, solvedCount);  // ì €ì¥ëœ ëª©í‘œë¡œ ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸
        document.getElementById('goal-actions').style.display = 'block';  // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ë³´ì´ê¸°
      }
    };

    // ëª©í‘œ ì„¤ì •
    function setDailyGoal() {
      const goal = parseInt(document.getElementById('goalInput').value);
      if (isNaN(goal) || goal <= 0) {
        alert("ìœ íš¨í•œ ëª©í‘œ ë¬¸ì œ ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      localStorage.setItem('dailyGoal', goal);
      localStorage.setItem('solvedToday', 0); // ìƒˆ ëª©í‘œ ì„¤ì • ì‹œ ì´ˆê¸°í™”
      updateGoalUI();
    }

    // +1 / -1 ë²„íŠ¼
    function changeSolvedCount(delta) {
      let current = parseInt(localStorage.getItem('solvedToday') || '0');
      const goal = parseInt(localStorage.getItem('dailyGoal') || '0');

      // +1 / -1ì„ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ í‘¼ ë¬¸ì œ ìˆ˜ ì—…ë°ì´íŠ¸
      current = Math.max(0, current + delta); // 0 ë¯¸ë§Œìœ¼ë¡œ ì•ˆ ë‚´ë ¤ê°€ê²Œ

      // localStorageì— í‘¼ ë¬¸ì œ ìˆ˜ ì €ì¥
      localStorage.setItem('solvedToday', current);

      // UI ì—…ë°ì´íŠ¸ (í‘¼ ë¬¸ì œ ìˆ˜ì™€ ëª©í‘œ ì—…ë°ì´íŠ¸)
      updateGoalUI();

      // ëª©í‘œ ë‹¬ì„± ì²´í¬: ëª©í‘œë¥¼ ë‹¬ì„±í•˜ë©´ ì¶•í•˜ ë©”ì‹œì§€ í‘œì‹œ
      if (goal > 0 && current >= goal) {
        document.getElementById('congratsMessage').style.display = 'block'; // ëª©í‘œ ë‹¬ì„± ì‹œ ë©”ì‹œì§€ í‘œì‹œ
      } else {
        document.getElementById('congratsMessage').style.display = 'none'; // ëª©í‘œ ë¯¸ë‹¬ì„± ì‹œ ë©”ì‹œì§€ ìˆ¨ê¹€
      }
    }

    // UI ì—…ë°ì´íŠ¸
    function updateGoalUI() {
      const goal = parseInt(localStorage.getItem('dailyGoal') || '0');
      const solved = parseInt(localStorage.getItem('solvedToday') || '0');

      if (goal > 0) {
        document.getElementById('progress-area').style.display = 'block';
        document.getElementById('goalCount').textContent = goal;
        document.getElementById('solvedCount').textContent = solved;

        const progress = Math.min(100, Math.round((solved / goal) * 100));
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = progress + '%';

        // if (progress === 100) {
        //   alert("ğŸ‰ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆì–´ìš”! ìˆ˜ê³ í–ˆì–´ìš”!");
        // }
      } else {
        document.getElementById('progress-area').style.display = 'none';
      }
    }

    // ëª©í‘œ ì´ˆê¸°í™”
    function resetGoal() {
      localStorage.removeItem('dailyGoal');
      localStorage.removeItem('solvedCount');
      document.getElementById('goalInput').value = '';
      document.getElementById('progress-area').style.display = 'none';
      document.getElementById('congratsMessage').style.display = 'none'; // ë©”ì‹œì§€ë„ ìˆ¨ê¸°ê¸°
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ë³µì›
    window.addEventListener('DOMContentLoaded', () => {
      updateGoalUI();
    });

    function showDailyGoalSection() {
      const section = document.getElementById('daily-goal-section');
      section.style.display = 'block';
      section.scrollIntoView({ behavior: 'smooth' });
    }

    async function showDailyGoalModal() {
      document.getElementById('dailyGoalModal').style.display = 'block';

      //   try {
      //   const res = await fetch('http://127.0.0.1:8000/daily_tip');  // âœ… ì •ìƒ ì‘ë™
      //   const data = await res.json();
      //   if (data.tip) {
      //     displayMessage(`ğŸ’¡ ${data.tip}`, 'bot-message');
      //   }
      // } catch (e) {
      //   console.log("GPT ë™ê¸°ë¶€ì—¬ ì‹¤íŒ¨", e);
      // }
    }


    function closeDailyGoalModal() {
      document.getElementById('dailyGoalModal').style.display = 'none';
    }

    async function fetchPopularProblems() {
  const bojUsername = localStorage.getItem('bojUsername');
  if (!bojUsername) {
    alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  try {
    const res = await fetch(`http://127.0.0.1:8000/popular_problems?boj_username=${bojUsername}`);
    const data = await res.json();

    if (data.error) {
      displayMessage(`âš  ${data.error}`, 'bot-message');
      return;
    }

    let html = `
      <div style="margin-top:10px;">
        <strong>ğŸ¥‡ í‹°ì–´ ì¸ê¸° ë¬¸ì œ ì¶”ì²œ</strong>
        ${data.problems.map(p => `
          <div style="margin-top:8px;">
            <a href="${p.url}" target="_blank">
              ğŸ“Œ ${p.title} (ğŸ”¥ ${p.solvedCount}ëª… í•´ê²°)
            </a>
          </div>`).join('')}
      </div>`;

    displayMessage(html, 'bot-message');

  } catch (error) {
    displayMessage("âš  ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'bot-message');
  }
}

// ê¸°ì¡´ì— ìˆë˜ displayMessage í•¨ìˆ˜ (ì´ë¯¸ ì¡´ì¬)
function displayMessage(msg, className) {
  const chatBox = document.getElementById('chat-box');
  const div = document.createElement('div');
  div.className = `message ${className}`;
  div.innerHTML = msg;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

async function fetchProblemFeedback(problemId) {
  const res = await fetch(`http://127.0.0.1:8000/problem_feedback?problem_id=${problemId}`);
  const data = await res.json();

  if (data.error) {
    displayMessage("âš  " + data.error, 'bot-message');
  } else {
    displayMessage("ğŸ§  <strong>ì „ëµ ìš”ì•½:</strong><br>" + data.feedback, 'bot-message');
  }
}

  </script>
</body>

</html>