<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- 메뉴 버튼 -->
        <div class="menu-button" onclick="toggleSidebar()">&#9776; </div>
        
        <!-- 사이드바 -->
        <div class="sidebar" id="sidebar">
            <div class="menu-item">📄 새 채팅</div>
            <div class="menu-item">⚙ 설정</div>
        </div>

        <!-- 채팅창 -->
        <div class="chat-container">
            <div class="chat-box" id="chat-box">
                <div class="message bot-message">안녕하세요! 무엇을 도와드릴까요?</div>
            </div>
            <textarea class="input-box" id="input-box" placeholder="메시지를 입력하세요..." rows="3"></textarea>
            
            <!-- 파일 업로드 입력 추가 -->
            <div class="file-voice-container">
                <input type="file" id="file-input" title="CSV 파일을 업로드하세요" />
                <button class="voice-button" onclick="startSpeechRecognition()">🎤</button>
            </div>
            <button class="send-button" onclick="sendMessage()">전송</button>
        </div>
    </div>

    <script>
        // 사이드바 토글 함수
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // 메시지 전송 함수
        async function sendMessage() {
            const inputBox = document.getElementById('input-box');
            const fileInput = document.getElementById('file-input');
            const message = inputBox.value;

            if (message.trim() !== "") {
                displayMessage(message, 'user-message');
                inputBox.value = ''; // 메시지 전송 후 입력창 비우기

                const formData = new FormData();
                formData.append('question', message);

                let url = "";

                // 파일이 있을 경우 분석 API 호출
                if (fileInput.files.length > 0) {
                    formData.append('file', fileInput.files[0]);
                    url = 'http://127.0.0.1:8000/analyze';
                } else {
                    // 파일이 없으면 일반 채팅 API 호출
                    url = 'http://127.0.0.1:8000/chat';
                } 

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    const botResponse = data.summary || data.answer || "죄송합니다, 알 수 없는 오류가 발생했습니다.";

                    displayMessage(botResponse, 'bot-message');

                    // 시각화 이미지가 있을 경우 추가 표시
                    if (data.image_url) {
                        displayImage(data.image_url);
                    }

                } catch (error) {
                    displayMessage("⚠ 서버와 통신 중 오류가 발생했습니다.", 'bot-message');
                    console.error(error);
                }
            }
        }

        // 메시지를 채팅창에 표시하는 함수
        function displayMessage(message, className) {
            const chatBox = document.getElementById('chat-box');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', className);
            messageElement.textContent = message;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight; // 스크롤을 최신 메시지로 이동
        }

        // 이미지 응답을 화면에 표시하는 함수
        function displayImage(imageUrl) {
            const chatBox = document.getElementById('chat-box');
            const imgElement = document.createElement('img');
            imgElement.src = imageUrl;
            imgElement.style.maxWidth = '100%';
            imgElement.style.marginTop = '10px';
            chatBox.appendChild(imgElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Enter 키 이벤트 추가
        document.addEventListener("DOMContentLoaded", function () {
            const inputBox = document.getElementById("input-box");

            if (inputBox) {
                inputBox.addEventListener("keydown", function (event) {
                    if ((event.key === "Enter" || event.key === "NumpadEnter") && !event.shiftKey) {
                        event.preventDefault(); // 기본 엔터 동작 방지
                        console.log("✅ 전송 실행됨!"); // 콘솔에서 확인용
                        sendMessage(); // 메시지 전송 함수 호출
                    }
                });
            } else { 
                console.error("❌ input-box를 찾을 수 없습니다!");
            }
        });
    </script>
</body>
</html>