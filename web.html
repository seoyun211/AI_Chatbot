<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <!-- 메뉴 버튼 -->
        <div class="menu-button" onclick="toggleSidebar()">&#9776; </div>

        <!-- 사이드바 -->
        <div class="sidebar" id="sidebar">
            <div class="menu-item" onclick="clearChat()">📄 새 채팅</div>
            <div class="menu-item" onclick="openSettings()">⚙ 설정</div>
        </div>

        <!-- 설정 페이지 (통합) -->
        <div class="settings-page" id="settings-page" style="display: none;">
            <div class="settings-header" id="settings-header">
                <span>⚙ 설정</span>
                <div class="window-controls">
                    <button class="minimize" onclick="minimizeSettings()">—</button>
                    <button class="restore" onclick="restoreSettings()">▢</button>
                    <button class="close" onclick="closeSettings()">X</button>
                </div>
            </div>

            <!-- 키보드 메뉴 -->
            <div class="menu-item" onclick="toggleStylePopup()">🎹 키보드</div>

            <!-- 글씨 크기 조절 팝업 -->
            <div id="style-popup"
                style="display:none; position:fixed; top:60%; left:50%; transform:translate(-50%, -50%);
        background:white; padding:15px; border:1px solid #ccc; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1001;">
                <strong>💡 글씨 크기 변경</strong>
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button onclick="setFontSize('small')">작게</button>
                    <button onclick="setFontSize('medium')">보통</button>
                    <button onclick="setFontSize('large')">크게</button>
                </div>
            </div>

            <!-- 다크 모드 -->
            <label>
                <input type="checkbox" id="dark-mode-toggle"> 다크 모드 활성화
            </label>
            <br>

            <!-- 채팅 저장 / 불러오기 -->
            <button onclick="saveChatHistory()">💾 채팅 저장</button>
            <button onclick="loadChatHistory()">📂 채팅 불러오기</button>
        </div>


        <!-- 채팅창 -->
        <div class="chat-container">
            <div class="chat-box" id="chat-box">
                <div class="message bot-message">안녕하세요! 무엇을 도와드릴까요?</div>
            </div>
            <textarea class="input-box" id="input-box" placeholder="메시지를 입력하세요..." rows="3"></textarea>

            <!-- 파일 업로드 입력 추가 -->
            <div class="file-voice-container">
                <input type="file" id="file-input" title="CSV 파일을 업로드하세요" />
                <button class="voice-button" onclick="startSpeechRecognition()">🎤</button>
            </div>
            <button class="send-button" onclick="sendMessage()">전송</button>
        </div>
    </div>

    <script>
        // 사이드바 토글
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // 새 채팅
        function clearChat() {
            document.getElementById('chat-box').innerHTML = '<div class="message bot-message">안녕하세요! 무엇을 도와드릴까요?</div>';
        }

        // 설정 열기
        function openSettings() {
            document.getElementById('settings-page').style.display = 'block';
        }

        // 설정 닫기
        function closeSettings() {
            document.getElementById('settings-page').style.display = 'none';
        }

        // 다크 모드 토글 (기본적으로 꺼짐)
        document.getElementById('dark-mode-toggle').addEventListener('change', function () {
            document.body.classList.toggle('dark-mode', this.checked);
            localStorage.setItem('darkMode', this.checked);
        });

        // 사이트 로드 시 기본 다크 모드 OFF 적용
        window.onload = function () {
            localStorage.setItem('darkMode', 'false'); // 기본값 꺼짐
            document.body.classList.remove('dark-mode');
            document.getElementById('dark-mode-toggle').checked = false;
        };

        // 채팅 저장
        function saveChatHistory() {
            localStorage.setItem('chatHistory', document.getElementById('chat-box').innerHTML);
            alert('채팅이 저장되었습니다!');
        }

        // 채팅 불러오기
        function loadChatHistory() {
            const savedChat = localStorage.getItem('chatHistory');
            if (savedChat) {
                document.getElementById('chat-box').innerHTML = savedChat;
            } else {
                alert('저장된 채팅이 없습니다.');
            }
        }

        // 메시지 전송
        async function sendMessage() {
            const inputBox = document.getElementById('input-box');
            const fileInput = document.getElementById('file-input');
            const message = inputBox.value.trim();

            if (message !== "") {
                displayMessage(message, 'user-message');
                inputBox.value = '';

                const formData = new FormData();
                formData.append('question', message);

                let url = fileInput.files.length > 0 ? 'http://127.0.0.1:8000/analyze' : 'http://127.0.0.1:8000/chat';

                try {
                    const response = await fetch(url, { method: 'POST', body: formData });
                    const data = await response.json();
                    displayMessage(data.summary || data.answer || "오류 발생", 'bot-message');
                } catch (error) {
                    displayMessage("⚠ 서버와 통신 중 오류 발생", 'bot-message');
                }
            }
        }

        // 메시지 표시
        function displayMessage(message, className) {
            const chatBox = document.getElementById('chat-box');
            const msgElement = document.createElement('div');
            msgElement.classList.add('message', className);
            msgElement.textContent = message;
            chatBox.appendChild(msgElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Enter 키 이벤트 처리 (Shift+Enter 줄바꿈, Enter 전송)
        document.getElementById("input-box").addEventListener("keydown", function (event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        // 설정 창 드래그 이동 기능 개선
        document.addEventListener("DOMContentLoaded", function () {
            const settingsPage = document.getElementById("settings-page");
            const header = document.getElementById("settings-header");

            header.addEventListener("mousedown", function (e) {
                let shiftX = e.clientX - settingsPage.offsetLeft;
                let shiftY = e.clientY - settingsPage.offsetTop;

                function moveAt(x, y) {
                    settingsPage.style.left = `${x - shiftX}px`;
                    settingsPage.style.top = `${y - shiftY}px`;
                }

                function onMouseMove(event) {
                    moveAt(event.clientX, event.clientY);
                }

                document.addEventListener("mousemove", onMouseMove);
                document.addEventListener("mouseup", function () {
                    document.removeEventListener("mousemove", onMouseMove);
                }, { once: true });
            });

            // 설정 열기/닫기 함수 전역에서 사용 가능하게 설정
            window.openSettings = openSettings;
            window.closeSettings = closeSettings;
        });

        function toggleStylePopup() {
            const popup = document.getElementById("style-popup");
            popup.style.display = popup.style.display === "none" ? "block" : "none";
        }

        function setFontSize(size) {
            const messages = document.querySelectorAll('.bot-message');
            messages.forEach(msg => {
                msg.classList.remove('size-small', 'size-medium', 'size-large');
                msg.classList.add(`size-${size}`);
            });
        }


    </script>
</body>

</html>