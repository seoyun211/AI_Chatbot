<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <!-- ë©”ë‰´ ë²„íŠ¼ -->
        <div class="menu-button" onclick="toggleSidebar()">&#9776; </div>

        <!-- ì‚¬ì´ë“œë°” -->
        <div class="sidebar" id="sidebar">
            <div class="menu-item" onclick="clearChat()">ğŸ“„ ìƒˆ ì±„íŒ…</div>
            <div class="menu-item" onclick="openSettings()">âš™ ì„¤ì •</div>
        </div>

        <!-- ì„¤ì • í˜ì´ì§€ (í†µí•©) -->
        <div class="settings-page" id="settings-page" style="display: none;">
            <div class="settings-header" id="settings-header">
                <span>âš™ ì„¤ì •</span>
                <div class="window-controls">
                    <button class="minimize" onclick="minimizeSettings()">â€”</button>
                    <button class="restore" onclick="restoreSettings()">â–¢</button>
                    <button class="close" onclick="closeSettings()">X</button>
                </div>
            </div>

            <!-- í‚¤ë³´ë“œ ë©”ë‰´ -->
            <div class="menu-item" onclick="toggleStylePopup()">ğŸ¹ í‚¤ë³´ë“œ</div>

            <!-- ê¸€ì”¨ í¬ê¸° ì¡°ì ˆ íŒì—… -->
            <div id="style-popup"
                style="display:none; position:fixed; top:60%; left:50%; transform:translate(-50%, -50%);
        background:white; padding:15px; border:1px solid #ccc; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1001;">
                <strong>ğŸ’¡ ê¸€ì”¨ í¬ê¸° ë³€ê²½</strong>
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button onclick="setFontSize('small')">ì‘ê²Œ</button>
                    <button onclick="setFontSize('medium')">ë³´í†µ</button>
                    <button onclick="setFontSize('large')">í¬ê²Œ</button>
                </div>
            </div>

            <!-- ë‹¤í¬ ëª¨ë“œ -->
            <label>
                <input type="checkbox" id="dark-mode-toggle"> ë‹¤í¬ ëª¨ë“œ í™œì„±í™”
            </label>
            <br>

            <!-- ì±„íŒ… ì €ì¥ / ë¶ˆëŸ¬ì˜¤ê¸° -->
            <button onclick="saveChatHistory()">ğŸ’¾ ì±„íŒ… ì €ì¥</button>
            <button onclick="loadChatHistory()">ğŸ“‚ ì±„íŒ… ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>


        <!-- ì±„íŒ…ì°½ -->
        <div class="chat-container">
            <div class="chat-box" id="chat-box">
                <div class="message bot-message">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
            </div>
            <textarea class="input-box" id="input-box" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>

            <!-- íŒŒì¼ ì—…ë¡œë“œ ì…ë ¥ ì¶”ê°€ -->
            <div class="file-voice-container">
                <input type="file" id="file-input" title="CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”" />
                <button class="voice-button" onclick="startSpeechRecognition()">ğŸ¤</button>
            </div>
            <button class="send-button" onclick="sendMessage()">ì „ì†¡</button>
        </div>
    </div>

    <script>
        // ì‚¬ì´ë“œë°” í† ê¸€
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // ìƒˆ ì±„íŒ…
        function clearChat() {
            document.getElementById('chat-box').innerHTML = '<div class="message bot-message">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>';
        }

        // ì„¤ì • ì—´ê¸°
        function openSettings() {
            document.getElementById('settings-page').style.display = 'block';
        }

        // ì„¤ì • ë‹«ê¸°
        function closeSettings() {
            document.getElementById('settings-page').style.display = 'none';
        }

        // ë‹¤í¬ ëª¨ë“œ í† ê¸€ (ê¸°ë³¸ì ìœ¼ë¡œ êº¼ì§)
        document.getElementById('dark-mode-toggle').addEventListener('change', function () {
            document.body.classList.toggle('dark-mode', this.checked);
            localStorage.setItem('darkMode', this.checked);
        });

        // ì‚¬ì´íŠ¸ ë¡œë“œ ì‹œ ê¸°ë³¸ ë‹¤í¬ ëª¨ë“œ OFF ì ìš©
        window.onload = function () {
            localStorage.setItem('darkMode', 'false'); // ê¸°ë³¸ê°’ êº¼ì§
            document.body.classList.remove('dark-mode');
            document.getElementById('dark-mode-toggle').checked = false;
        };

        // ì±„íŒ… ì €ì¥
        function saveChatHistory() {
            localStorage.setItem('chatHistory', document.getElementById('chat-box').innerHTML);
            alert('ì±„íŒ…ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ì±„íŒ… ë¶ˆëŸ¬ì˜¤ê¸°
        function loadChatHistory() {
            const savedChat = localStorage.getItem('chatHistory');
            if (savedChat) {
                document.getElementById('chat-box').innerHTML = savedChat;
            } else {
                alert('ì €ì¥ëœ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const inputBox = document.getElementById('input-box');
            const fileInput = document.getElementById('file-input');
            const message = inputBox.value.trim();

            if (message !== "") {
                displayMessage(message, 'user-message');
                inputBox.value = '';

                const formData = new FormData();
                formData.append('question', message);

                let url = fileInput.files.length > 0 ? 'http://127.0.0.1:8000/analyze' : 'http://127.0.0.1:8000/chat';

                try {
                    const response = await fetch(url, { method: 'POST', body: formData });
                    const data = await response.json();
                    displayMessage(data.summary || data.answer || "ì˜¤ë¥˜ ë°œìƒ", 'bot-message');
                } catch (error) {
                    displayMessage("âš  ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ", 'bot-message');
                }
            }
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function displayMessage(message, className) {
            const chatBox = document.getElementById('chat-box');
            const msgElement = document.createElement('div');
            msgElement.classList.add('message', className);
            msgElement.textContent = message;
            chatBox.appendChild(msgElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Enter í‚¤ ì´ë²¤íŠ¸ ì²˜ë¦¬ (Shift+Enter ì¤„ë°”ê¿ˆ, Enter ì „ì†¡)
        document.getElementById("input-box").addEventListener("keydown", function (event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        // ì„¤ì • ì°½ ë“œë˜ê·¸ ì´ë™ ê¸°ëŠ¥ ê°œì„ 
        document.addEventListener("DOMContentLoaded", function () {
            const settingsPage = document.getElementById("settings-page");
            const header = document.getElementById("settings-header");

            header.addEventListener("mousedown", function (e) {
                let shiftX = e.clientX - settingsPage.offsetLeft;
                let shiftY = e.clientY - settingsPage.offsetTop;

                function moveAt(x, y) {
                    settingsPage.style.left = `${x - shiftX}px`;
                    settingsPage.style.top = `${y - shiftY}px`;
                }

                function onMouseMove(event) {
                    moveAt(event.clientX, event.clientY);
                }

                document.addEventListener("mousemove", onMouseMove);
                document.addEventListener("mouseup", function () {
                    document.removeEventListener("mousemove", onMouseMove);
                }, { once: true });
            });

            // ì„¤ì • ì—´ê¸°/ë‹«ê¸° í•¨ìˆ˜ ì „ì—­ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
            window.openSettings = openSettings;
            window.closeSettings = closeSettings;
        });

        function toggleStylePopup() {
            const popup = document.getElementById("style-popup");
            popup.style.display = popup.style.display === "none" ? "block" : "none";
        }

        function setFontSize(size) {
            const messages = document.querySelectorAll('.bot-message');
            messages.forEach(msg => {
                msg.classList.remove('size-small', 'size-medium', 'size-large');
                msg.classList.add(`size-${size}`);
            });
        }


    </script>
</body>

</html>