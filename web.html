<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- ë©”ë‰´ ë²„íŠ¼ -->
        <div class="menu-button" onclick="toggleSidebar()">&#9776; </div>
        
        <!-- ì‚¬ì´ë“œë°” -->
        <div class="sidebar" id="sidebar">
            <div class="menu-item">ğŸ“„ ìƒˆ ì±„íŒ…</div>
            <div class="menu-item">âš™ ì„¤ì •</div>
        </div>

        <!-- ì±„íŒ…ì°½ -->
        <div class="chat-container">
            <div class="chat-box" id="chat-box">
                <div class="message bot-message">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
            </div>
            <textarea class="input-box" id="input-box" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
            
            <!-- íŒŒì¼ ì—…ë¡œë“œ ì…ë ¥ ì¶”ê°€ -->
            <div class="file-voice-container">
                <input type="file" id="file-input" title="CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”" />
                <button class="voice-button" onclick="startSpeechRecognition()">ğŸ¤</button>
            </div>
            <button class="send-button" onclick="sendMessage()">ì „ì†¡</button>
        </div>
    </div>

    <script>
        // ì‚¬ì´ë“œë°” í† ê¸€ í•¨ìˆ˜
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
        async function sendMessage() {
            const inputBox = document.getElementById('input-box');
            const fileInput = document.getElementById('file-input');
            const message = inputBox.value;

            if (message.trim() !== "") {
                displayMessage(message, 'user-message');
                inputBox.value = ''; // ë©”ì‹œì§€ ì „ì†¡ í›„ ì…ë ¥ì°½ ë¹„ìš°ê¸°

                const formData = new FormData();
                formData.append('question', message);

                let url = "";

                // íŒŒì¼ì´ ìˆì„ ê²½ìš° ë¶„ì„ API í˜¸ì¶œ
                if (fileInput.files.length > 0) {
                    formData.append('file', fileInput.files[0]);
                    url = 'http://127.0.0.1:8000/analyze';
                } else {
                    // íŒŒì¼ì´ ì—†ìœ¼ë©´ ì¼ë°˜ ì±„íŒ… API í˜¸ì¶œ
                    url = 'http://127.0.0.1:8000/chat';
                } 

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    const botResponse = data.summary || data.answer || "ì£„ì†¡í•©ë‹ˆë‹¤, ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";

                    displayMessage(botResponse, 'bot-message');

                    // ì‹œê°í™” ì´ë¯¸ì§€ê°€ ìˆì„ ê²½ìš° ì¶”ê°€ í‘œì‹œ
                    if (data.image_url) {
                        displayImage(data.image_url);
                    }

                } catch (error) {
                    displayMessage("âš  ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'bot-message');
                    console.error(error);
                }
            }
        }

        // ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function displayMessage(message, className) {
            const chatBox = document.getElementById('chat-box');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', className);
            messageElement.textContent = message;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight; // ìŠ¤í¬ë¡¤ì„ ìµœì‹  ë©”ì‹œì§€ë¡œ ì´ë™
        }

        // ì´ë¯¸ì§€ ì‘ë‹µì„ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function displayImage(imageUrl) {
            const chatBox = document.getElementById('chat-box');
            const imgElement = document.createElement('img');
            imgElement.src = imageUrl;
            imgElement.style.maxWidth = '100%';
            imgElement.style.marginTop = '10px';
            chatBox.appendChild(imgElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Enter í‚¤ ì´ë²¤íŠ¸ ì¶”ê°€
        document.addEventListener("DOMContentLoaded", function () {
            const inputBox = document.getElementById("input-box");

            if (inputBox) {
                inputBox.addEventListener("keydown", function (event) {
                    if ((event.key === "Enter" || event.key === "NumpadEnter") && !event.shiftKey) {
                        event.preventDefault(); // ê¸°ë³¸ ì—”í„° ë™ì‘ ë°©ì§€
                        console.log("âœ… ì „ì†¡ ì‹¤í–‰ë¨!"); // ì½˜ì†”ì—ì„œ í™•ì¸ìš©
                        sendMessage(); // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜ í˜¸ì¶œ
                    }
                });
            } else { 
                console.error("âŒ input-boxë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
            }
        });
    </script>
</body>
</html>