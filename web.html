<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Baekjoon Chatbot</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* 기존 style-popup은 밝은 테마 */
    #style-popup {
      background: white;
      color: black;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      display: none;
    }

    /* 다크 모드 전용 style-popup */
    body.dark-mode #style-popup {
      background: #333;
      color: #fff;
      border: 2px solid #888;
    }

    body.dark-mode #style-popup button {
      background-color: #444;
      color: #fff;
      border: 1px solid #aaa;
    }

    body.dark-mode #style-popup button:hover {
      background-color: #555;
    }

    .button-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .chat-button {
      padding: 10px 15px;
      background-color: #f5f5f5;
      color: rgb(16, 43, 30);
      border: none;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .chat-button:hover {
      background-color: #bdbdbd
    }

    /* 일반 모드에서 메뉴 항목에 마우스를 올렸을 때 배경 강조 색상 */
    .sidebar .menu-item:hover {
      background-color: #f0f0f0;
    }

    /* 다크 모드에서 메뉴 항목에 마우스를 올렸을 때 배경과 글씨 강조 색상 */
    .dark-mode .sidebar .menu-item:hover {
      background-color: #444;
      color: #fff;
    }
  </style>
</head>

<body>
  <!-- 👤 백준 아이디 입력 화면 -->
  <div class="intro-container" id="intro-page">
    <h2>👋 백준 아이디를 입력하세요</h2>
    <input type="text" id="boj-username" placeholder="ex joonas123" style="padding: 10px; font-size: 16px;" />
    <br /><br />
    <button onclick="startChat()" style="padding: 10px 20px; font-size: 16px;">시작하기</button>
  </div>

  <!-- 🤖 챗봇 화면 -->
  <div class="container" id="chat-page" style="display: none;">
    <div class="menu-button" onclick="toggleSidebar()">&#9776;</div>

    <!-- 사이드바 -->
    <div class="sidebar" id="sidebar">
      <div class="menu-item" onclick="clearChat()">📄 새 채팅</div>
      <div class="menu-item" onclick="openPromptSettings()">🧠 프롬프트 설정</div>
      <div class="menu-item" onclick="openSettings()">⚙ 설정</div>
    </div>

    <!-- 설정 페이지 -->
    <div class="settings-page" id="settings-page" style="display: none;">
      <div class="settings-header" id="settings-header">
        <span>⚙ 설정</span>
        <div class="window-controls">
          <button class="close-btn" onclick="closeSettings()">X</button>
        </div>
      </div>
      <div class="menu-item" onclick="toggleStylePopup()">🎹 키보드</div>
      <div id="style-popup" style="display:none; position:fixed; top:60%; left:50%;
        background:white; padding:15px; border:1px solid #ccc; border-radius:10px;
        box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1001; min-width: 260px;">
        <!-- 🔧 헤더 영역 -->
        <div class="popup-header" id="popup-drag-header"
          style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: move;">
          <strong class="popup-title">💡 글씨 크기 변경</strong>
          <button onclick="closeStylePopup()"
            style="background:none; border:none; font-size: 16px; cursor:pointer;">❌</button>
        </div>
        <!-- 버튼 영역 -->
        <div class="button-group">
          <button class="font-button" onclick="setFontSize('small')">작게</button>
          <button class="font-button" onclick="setFontSize('medium')">보통</button>
          <button class="font-button" onclick="setFontSize('large')">크게</button>
        </div>
      </div>
      <label><input type="checkbox" id="dark-mode-toggle" /> 다크 모드 활성화</label><br />
      <button onclick="saveChatHistory()">💾 채팅 저장</button>
      <button onclick="loadChatHistory()">📂 채팅 불러오기</button>
    </div>

    <!-- 채팅창 -->
    <div class="chat-container">
      <div class="chat-box" id="chat-box"></div>
      <textarea class="input-box" id="input-box" placeholder="메시지를 입력하세요." rows="3"></textarea>
      <button class="send-button" onclick="sendMessage()">전송</button>
    </div>

    <!-- ✅ web.html 수정 내용 전체
<!-- ✅ 사이드바에 프롬프트 설정 메뉴 추가 -->
    <!-- ✅ 프롬프트 설정 모달 -->
    <div class="modal" id="promptModal"
      style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000;">
      <div class="modal-content"
        style="background:white; padding:20px; max-width:500px; margin:100px auto; border-radius:12px; position:relative;">
        <span class="close" onclick="closePromptSettings()"
          style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:18px;">❌</span>
        <h3>🧠 사용자 프롬프트 설정</h3>
        <textarea id="custom-prompt" rows="4" style="width: 100%; margin-bottom: 10px;"></textarea>
        <button onclick="saveCustomPrompt()">💾 저장</button>
        <button onclick="viewPromptHistory()">🕘 기록 보기</button>
        <div id="prompt-history" style="margin-top: 10px; font-size: 14px; color: #444;"></div>
      </div>
    </div>

    <script>
      // ✅ 프롬프트 설정 모달 열기
      function openPromptSettings() {
        document.getElementById("promptModal").style.display = "block";
        document.getElementById("custom-prompt").value = localStorage.getItem("customPrompt") || "";
        viewPromptHistory(); // 열릴 때 기록도 같이 보여줌
      }

      // ✅ 프롬프트 설정 모달 닫기
      function closePromptSettings() {
        document.getElementById("promptModal").style.display = "none";
      }

      // ✅ 프롬프트 저장
      function saveCustomPrompt() {
        const value = document.getElementById("custom-prompt").value.trim();
        if (!value) return alert("프롬프트를 입력해주세요");
        localStorage.setItem("customPrompt", value);

        // 프롬프트 기록 추가
        const history = JSON.parse(localStorage.getItem("promptHistory") || "[]");
        history.push({ value, date: new Date().toLocaleString() });
        localStorage.setItem("promptHistory", JSON.stringify(history));

        alert("프롬프트가 저장되었습니다!");
        viewPromptHistory(); // 저장 후 갱신
      }

      // ✅ 프롬프트 기록 보기 및 삭제 가능
      function viewPromptHistory() {
        const history = JSON.parse(localStorage.getItem("promptHistory") || "[]");
        const container = document.getElementById("prompt-history");
        if (history.length === 0) {
          container.innerHTML = "<p>저장된 기록이 없습니다.</p>";
          return;
        }
        container.innerHTML = history.map((h, i) => `
      <div style="margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 6px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>🕘 ${h.date}</strong>
          <button onclick="deletePrompt(${i})" style="background:#f44336; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">삭제</button>
        </div>
        <div style="margin-top: 4px; white-space: pre-wrap;">${h.value}</div>
      </div>
    `).join("");
      }

      // ✅ 프롬프트 기록 삭제
      function deletePrompt(index) {
        let history = JSON.parse(localStorage.getItem("promptHistory") || "[]");
        if (!confirm("이 프롬프트 기록을 삭제할까요?")) return;
        history.splice(index, 1);
        localStorage.setItem("promptHistory", JSON.stringify(history));
        viewPromptHistory(); // 다시 그려줌
      }
    </script>

    <!-- 데일리 목표 모달 -->
    <div id="dailyGoalModal" class="modal"
      style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000;">
      <div
        style="background:white; padding:20px; max-width:400px; margin:100px auto; border-radius:12px; position:relative;">
        <span onclick="closeDailyGoalModal()"
          style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:18px;">❌</span>
        <h3 style="margin-top:10px; margin-bottom:20px;">🎯 데일리 목표 설정</h3>

        <label for="goalInput">목표 문제 수:</label>
        <input type="number" id="goalInput" min="1" style="width: 80px; margin: 8px 0;"><br>
        <button onclick="setDailyGoal()">목표 설정</button>

        <div id="progress-area"
          style="margin-top: 20px; display: none; text-align: center; position: relative; z-index: 10;">
          <p
            style="font-size: 16px; font-weight: bold; margin: 0; text-align: center; padding-right: 20px; position: relative;">
            현재 푼 문제 수:
            <span id="solvedCount" style="font-weight: bold; position: static;">0</span> /
            <span id="goalCount" style="color: #2c3e50; position: static; display: inline;">0</span>
          </p>
          <div style="background-color: #eee; border-radius: 6px; overflow: hidden; height: 20px; margin-top: 10px;">
            <div id="progressBar" style="height: 100%; width: 0%; background-color: #4CAF50;"></div>
          </div>
          <div style="margin-top: 10px; text-align: center;">
            <button onclick="changeSolvedCount(1)">+1</button>
            <button onclick="changeSolvedCount(-1)">-1</button>
            <button onclick="resetGoal()">목표 초기화</button>
          </div>
          <div id="congratsMessage"
            style="display:none; text-align:center; color:green; font-weight:bold; font-size:18px; margin-top:10px;">
            🎉 목표 달성! 🎉
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function startChat() {
      const username = document.getElementById('boj-username').value.trim();
      if (!username) {
        alert('백준 아이디를 입력해주세요!');
        return;
      }
      localStorage.setItem('bojUsername', username);
      document.getElementById('intro-page').style.display = 'none';
      document.getElementById('chat-page').style.display = 'flex';

      displayMessage(`${username}님, 무엇을 분석해 드릴까요?`, 'bot-message');
      showMainOptions();
    }

    async function sendMessage(skipUserMessage = false) {
      const inputBox = document.getElementById('input-box');
      const fileInput = document.getElementById('file-input');
      const message = inputBox.value.trim();
      const bojUsername = localStorage.getItem('bojUsername') || "";

      if (!message) return;

      if (!skipUserMessage) {
        displayMessage(message, 'user-message');
      }

      inputBox.value = '';

      const formData = new FormData();
      formData.append('question', message);
      formData.append('boj_username', bojUsername);
      formData.append('prompt', localStorage.getItem("customPrompt") || "");  // ✅ 프롬프트 포함

      const url = fileInput && fileInput.files && fileInput.files.length > 0
        ? 'http://127.0.0.1:8000/analyze'
        : 'http://127.0.0.1:8000/chat';

      try {
        const response = await fetch(url, { method: 'POST', body: formData });
        const data = await response.json();
        displayMessage(data.summary || data.answer || "오류 발생", 'bot-message');
      } catch (error) {
        displayMessage("⚠ 서버와 통신 중 오류 발생", 'bot-message');
      }
    }


    function displayMessage(msg, className) {
      const chatBox = document.getElementById('chat-box');
      const div = document.createElement('div');
      div.className = `message ${className}`;
      div.innerHTML = msg;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    document.getElementById('input-box').addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    document.getElementById('dark-mode-toggle').addEventListener('change', function () {
      document.body.classList.toggle('dark-mode', this.checked);
      localStorage.setItem('darkMode', this.checked);
    });

    window.onload = function () {
      const savedDark = localStorage.getItem('darkMode') === 'true';
      document.body.classList.toggle('dark-mode', savedDark);
      document.getElementById('dark-mode-toggle').checked = savedDark;
    };

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    function clearChat() {
      document.getElementById('chat-box').innerHTML = '<div class="message bot-message">안녕하세요! 무엇을 도와드릴까요?</div>';
      showMainOptions(); // 새 채팅 시 다시 버튼 보여줌
    }

    function openSettings() {
      document.getElementById('settings-page').style.display = 'block';
    }

    function closeSettings() {
      document.getElementById('settings-page').style.display = 'none';
    }

    function toggleStylePopup() {
      const popup = document.getElementById("style-popup");
      popup.style.display = popup.style.display === "none" ? "block" : "none";
    }

    function setFontSize(size) {
      const messages = document.querySelectorAll('.bot-message, .user-message');
      messages.forEach(msg => {
        msg.classList.remove('size-small', 'size-medium', 'size-large');
        msg.classList.add(`size-${size}`);
      });
    }

    function saveChatHistory() {
      localStorage.setItem('chatHistory', document.getElementById('chat-box').innerHTML);
      alert('채팅이 저장되었습니다!');
    }

    function loadChatHistory() {
      const savedChat = localStorage.getItem('chatHistory');
      if (savedChat) {
        document.getElementById('chat-box').innerHTML = savedChat;
      } else {
        alert('저장된 채팅이 없습니다.');
      }
    }

    // ✅ 분석 버튼 UI 출력
    function showMainOptions() {
      const chatBox = document.getElementById('chat-box');

      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'button-container';
      buttonContainer.style.marginTop = '15px';
      buttonContainer.style.marginBottom = '15px';


      const buttons = [
        { label: '👤 내 백준 정보 보기', message: '내 백준 정보 보기' },
        { label: '📅 주간 활동 보기', message: '주간 활동 보기' },
        { label: '📊 풀이 분포 보기', message: '풀이 분포 보기' },
        { label: '📈 난이도 추세', message: '난이도 추세' },
        { label: '📈 등급 별 공부법', message: '등급 별 공부법' },
        { label: '🏆 도전 과제 생성', message: '도전 과제 생성' },
        { label: '🤖 AI 문제 추천', message: 'AI문제 추천' },
        { label: '🏅 티어 체험하기', message: '티어 체험' },
        { label: '🧠 문제 풀이 전략 받기', message: '문제 풀이 전략' },
        { label: '🥇 티어 인기 문제 추천', message: '티어 인기 문제 추천' },
        { label: '🎯 데일리 목표 설정', action: showDailyGoalModal }
      ];

      buttons.forEach(btn => {
        const button = document.createElement('button');
        button.textContent = btn.label;
        button.className = 'chat-button';  // 버튼에 클래스 추가

        // 버튼 클릭 시 action 실행
        button.onclick = () => {
          if (btn.action) {
            // action이 있을 경우 해당 함수를 실행 (모달 열기 등)
            btn.action();  // openGoalModal() 실행
          } else {
            // action이 없을 경우 원래대로 메시지 처리
            displayMessage(` ${btn.label}`, 'user-message');
            sendAutoMessage(btn.message);
          }
        };

        // 버튼을 버튼 컨테이너에 추가
        buttonContainer.appendChild(button);
      });

      chatBox.appendChild(buttonContainer);
      chatBox.scrollTop = chatBox.scrollHeight;

    }

    // ✅ 버튼 클릭 시 자동 메시지 전송 
    function sendAutoMessage(message) {
      const inputBox = document.getElementById('input-box');
      inputBox.value = message;

      if (message === "내 백준 정보 보기") {
        const username = localStorage.getItem('bojUsername');
        if (username) {
          fetchUserInfo(username);
        } else {
          displayMessage("⚠ 사용자 정보를 찾을 수 없습니다.", 'bot-message');
        }
      } else if (message === "AI문제 추천") {
        recommendProblem();  // 랜덤 문제 추천 시 recommendProblem 호출
      } else if (message === "풀이 분포 보기") {
        showDistribution();
      } else if (message === "도전 과제 생성") {
        generateChallenge();  // 새 함수 호출
      } else if (message === "티어 체험") {
        generateTierExperience();
      } else if (message === "주간 활동 보기") {
        showWeeklyChart();
      }  else if (message === "티어 인기 문제 추천") { 
        fetchPopularProblems(); 
      } else if (message === "등급 별 공부법") {
        getRankUpTip();
      } else if (message === "문제 풀이 전략") {
        const pid = prompt("문제 번호를 입력하세요 (예: 1000):");
        if (pid) fetchProblemFeedback(pid);
      } else {
        sendMessage(true);
      }

    }

    function closeStylePopup() {
      document.getElementById("style-popup").style.display = "none";
    }

    // 내정보
    async function fetchUserInfo(username) {
      try {
        const res = await fetch(`http://127.0.0.1:8000/userinfo?boj_username=${username}`);
        const data = await res.json();
        if (data.error) {
          alert(data.error);
        } else {

          const tierMap = [
            "Unrated",
            "Bronze V", "Bronze IV", "Bronze III", "Bronze II", "Bronze I",
            "Silver V", "Silver IV", "Silver III", "Silver II", "Silver I",
            "Gold V", "Gold IV", "Gold III", "Gold II", "Gold I",
            "Platinum V", "Platinum IV", "Platinum III", "Platinum II", "Platinum I",
            "Diamond V", "Diamond IV", "Diamond III", "Diamond II", "Diamond I",
            "Ruby V", "Ruby IV", "Ruby III", "Ruby II", "Ruby I",
            "Master", "Grandmaster", "Challenger"
          ];
          const userTierName = tierMap[data.tier] || "Unknown";

          const cardHTML = `
          <div class="boj-card">
            <div class="boj-card-header">👤 ${username}님의 백준 정보</div>
            <div class="boj-info-grid">
              <div class="info-item">🎖 티어:<strong>${userTierName}</strong></div>
              <div class="info-item">📈 랭킹:<strong>${data.rank}</strong></div>
              <div class="info-item">✅ 푼 문제 수:<strong>${data.solved_count}</strong></div>
              <div class="info-item">🏫 클래스:<strong>${data.class}</strong></div>
              <div class="info-item">🔥 최장 스트릭:<strong>${data.max_streak}</strong></div>
              <div class="info-item">📊 실력 점수:<strong>${data.rating}</strong></div>
            </div>
          </div>
        `;
          displayMessage(cardHTML, 'bot-message');  // HTML 출력 함수
        }
      } catch (e) {
        displayMessage("⚠ 사용자 정보를 불러오는 데 실패했습니다.", 'bot-message');
      }
    }
    // 랜덤문제추천
    async function recommendProblem() {
      const bojUsername = localStorage.getItem('bojUsername');
      if (!bojUsername) {
        displayMessage("⚠ 사용자 정보가 없습니다.", 'bot-message');
        return;
      }

      try {
        // const res = await fetch(`http://127.0.0.1:8000/recommend?boj_username=${bojUsername}`);
        const res = await fetch(`http://127.0.0.1:8000/recommend?boj_username=${bojUsername}`);

        const data = await res.json();


        if (data.error) {
          displayMessage(data.error, 'bot-message');
        } else {
          const problemLink = `https://www.acmicpc.net/problem/${data.problemId}`;
          const tierImageUrl = `https://static.solved.ac/tier_small/${data.tier}.svg`;

          const cardHtml = `
        <div style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #ffffff;
          border-radius: 12px;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
          padding: 16px;
          margin: 18px 0;
          max-width: 640px;
        ">
          <div style="flex: 1; padding-right: 16px;">
            <h3 style="margin: 0 0 8px 0; font-size: 18px;">🧠 ${data.title}</h3>
            <p style="margin: 2px 0;">📌 문제 번호: <strong>${data.problemId}</strong></p>
            <p style="margin: 2px 0;">⭐ 티어: ${data.tierName}</p>
            <p style="margin: 6px 0; color: #444; font-size: 13.5px; line-height: 1.4;"> 티어에 맞게 랜덤으로 문제를 추천해줍니다.</p>
            <a href="${problemLink}" target="_blank" style="
              display: inline-block;
              margin-top: 6px;
              padding: 6px 12px;
              background-color: #4CAF50;
              color: white;
              border-radius: 16px;
              text-decoration: none;
              font-weight: bold;
              font-size: 14px;
              transition: background 0.3s;
            " onmouseover="this.style.backgroundColor='#45a049'" onmouseout="this.style.backgroundColor='#4CAF50'"> 👉 문제 풀러 가기
            </a>
          </div>
          <div style="flex-shrink: 0;">
            <img src="${tierImageUrl}" alt="티어" style="width: 64px; height: 64px;" />
          </div>
        </div>
      `;

          const chatBox = document.getElementById("chat-box");
          const div = document.createElement("div");
          div.className = "message bot-message";
          div.innerHTML = cardHtml;
          chatBox.appendChild(div);
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      } catch (error) {
        displayMessage("⚠ 추천 문제를 가져오는 중 오류가 발생했습니다.", 'bot-message');
      }
    }

    let chartInstance = null;  // 전역으로 Chart 인스턴스를 저장

    async function showDistribution() {
      const bojUsername = localStorage.getItem('bojUsername');
      if (!bojUsername) {
        displayMessage("⚠ 사용자 정보가 없습니다.", 'bot-message');
        return;
      }

      try {
        const res = await fetch(`http://127.0.0.1:8000/distribution?boj_username=${bojUsername}`);
        const data = await res.json();

        if (data.error) {
          displayMessage(data.error, 'bot-message');
          return;
        }

        // ✅ 수정된 부분: 백엔드 응답 데이터 필드 정확히 맞춤
        const levels = data.levels;
        const counts = data.counts;

        console.log("📊 levels", levels);
        console.log("📊 counts", counts);

        const canvasId = 'difficulty-chart';
        const chartHtml = `
      <div style="max-width: 500px; margin-top: 16px;">
        <h4>📊 난이도 별 풀이 분포</h4>
        <canvas id="${canvasId}" width="400" height="300"></canvas>
      </div>
    `;
        displayMessage(chartHtml, 'bot-message');

        // DOM 그려진 다음 안전하게 실행
        setTimeout(() => {
          const ctx = document.getElementById(canvasId)?.getContext('2d');
          if (!ctx) {
            console.error("🎯 canvas를 찾을 수 없습니다.");
            return;
          }

          // 이전 차트 인스턴스 제거
          if (chartInstance !== null) {
            chartInstance.destroy();
          }

          chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: levels,
              datasets: [{
                label: '풀이한 문제 수',
                data: counts,
                backgroundColor: '#4CAF50',
                borderRadius: 8,
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  beginAtZero: true,
                  // ✅ 여기 추가: 최대값 설정 (자동 최대값이 너무 작을 때 대비)
                  suggestedMax: Math.max(...counts) + 10,  // 최댓값 + 여유
                  ticks: {
                    stepSize: 1
                  }
                }
              }
            }
          });


        }, 150);  // DOM 생성 대기 시간

      } catch (err) {
        displayMessage("⚠ 분포 데이터를 불러오는 데 실패했습니다.", 'bot-message');
      }
    }

    //티어체험
    async function generateTierExperience() {
      console.log("✅ 티어 체험 함수 호출됨");

      const randomTier = Math.floor(Math.random() * (30 - 16 + 1)) + 16;

      const res = await fetch(`http://127.0.0.1:8000/tier_experience?tier=${randomTier}`);
      const data = await res.json();

      if (data.error) {
        displayMessage("⚠ 티어 체험 문제를 불러올 수 없습니다.", "bot-message");
        return;
      }

      const div = document.createElement("div");
      div.className = "message bot-message";

      let html = `
        <div style="background: #f0f8ff; border-radius: 12px; padding: 20px;
                    margin: 20px 0; max-width: 640px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
          <h3 style="margin: 0 0 20px; color: #3558a2;">🏅 ${data.tier_name} 티어 체험해보기</h3>
      `;

      data.problems.forEach((p, i) => {
        html += `
          <div style="display: flex; justify-content: space-between; align-items: center;
                      background-color: #ffffff; border: 1.5px solid #d0d8e8;
                      border-radius: 10px; padding: 14px 18px; margin-bottom: 12px;
                      box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: transform 0.2s;"
              onmouseover="this.style.transform='scale(1.01)'" 
              onmouseout="this.style.transform='scale(1)'">
            <div style="font-size: 15px; font-weight: 600; color: #333;text-align: left; flex: 1;">
              ${i + 1}. ${p.title}
            </div>
            <a href="${p.url}" target="_blank" style="
              padding: 6px 10px; background: #4e83f1; color: white;
              text-decoration: none; border-radius: 6px; font-size: 13px;
              font-weight: 500;">
              문제 풀기 🔗
            </a>
          </div>
        `;
      });

      html += "</div>";
      div.innerHTML = html;
      document.getElementById("chat-box").appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }


    // 도전 과제 생성
    async function generateChallenge() {
      const bojUsername = localStorage.getItem('bojUsername');
      if (!bojUsername) {
        displayMessage("⚠ 사용자 정보가 없습니다.", 'bot-message');
        return;
      }

      const res = await fetch(`http://127.0.0.1:8000/challenge?boj_username=${bojUsername}`);
      const data = await res.json();

      console.log(data);

      if (data.error) {
        displayMessage(data.error, 'bot-message');
        return;
      }

      const div = document.createElement("div");
      div.className = "message bot-message";
      div.innerHTML = data.challenge;
      document.getElementById("chat-box").appendChild(div);

      // 🔽 카드 HTML 구성
      let html = `
        <div style="background: #ffffff; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 16px; margin: 18px 0; max-width: 640px;">
          <h3 style="margin-bottom: 10px;">🎯 ${data.title}</h3>
          <p style="margin: 6px 0;"> 다음 티어를 향해 도전해보세요!</p>
      `;

      data.problems.forEach((p, i) => {
        html += `
          <a href="https://www.acmicpc.net/problem/${p.id}" target="_blank" style="
            display: block;
            margin: 8px 0;
            padding: 14px 16px;
            background-color: #ffffff;
            border: 1.5px solid #ddd;
            border-radius: 10px;
            text-decoration: none;
            color: #222;
            font-weight: 600;
            transition: background 0.2s;, transform 0.1s;
          " onmouseover="this.style.backgroundColor='#f0f0f0'; this.style.transform='scale(1.01)'"
            onmouseout="this.style.backgroundColor='#ffffff'; this.style.transform='scale(1)'">
            ${i + 1}. ${p.title}
          </a>
        `;
      });

      html += `</div>`;
      div.innerHTML = html;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // 한주기록 시각화
    async function showWeeklyChart() {
      const bojUsername = localStorage.getItem('bojUsername');
      if (!bojUsername) {
        displayMessage("⚠ 사용자 정보가 없습니다.", 'bot-message');
        return;
      }

      const res = await fetch(`http://127.0.0.1:8000/weekly_activity?boj_username=${bojUsername}`);
      const data = await res.json();

      if (data.error) {
        displayMessage(data.error, 'bot-message');
        return;
      }

      const canvasId = 'weekly-chart';
      const chartHtml = `
    <div style="max-width: 500px; margin-top: 16px;">
      <h4>📆 이번 주 풀이 현황</h4>
      <canvas id="${canvasId}" width="400" height="300"></canvas>
    </div>
  `;
      displayMessage(chartHtml, 'bot-message');

      setTimeout(() => {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (chartInstance !== null) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.days,
            datasets: [{
              label: '푼 문제 수',
              data: data.counts,
              backgroundColor: '#337ab7',
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              y: {
                beginAtZero: true,
                suggestedMax: Math.max(...data.counts) + 3,
                ticks: { stepSize: 1 }
              }
            }
          }
        });
      }, 150);
    }


    const settingsPage = document.getElementById("settings-page");
    const settingsHeader = document.getElementById("settings-header");

    let draggingSettings = false;
    let offsetX_settings = 0;
    let offsetY_settings = 0;

    settingsHeader.addEventListener("mousedown", function (e) {
      // 설정창의 현재 위치를 실제 좌표로 계산
      const rect = settingsPage.getBoundingClientRect();

      // transform을 없애고 현재 위치를 top/left로 고정
      settingsPage.style.left = `${rect.left}px`;
      settingsPage.style.top = `${rect.top}px`;
      settingsPage.style.transform = "none"; // 중요!!

      offsetX_settings = e.clientX - rect.left;
      offsetY_settings = e.clientY - rect.top;
      draggingSettings = true;
    });

    document.addEventListener("mousemove", function (e) {
      if (!draggingSettings) return;

      const x = e.clientX - offsetX_settings;
      const y = e.clientY - offsetY_settings;

      settingsPage.style.left = `${x}px`;
      settingsPage.style.top = `${y}px`;
    });

    document.addEventListener("mouseup", function () {
      draggingSettings = false;
    });


    function saveGoal() {
      // 목표 수 가져오기
      const goalInput = document.getElementById('goalInput');
      let dailyGoal = parseInt(goalInput.value);

      // 목표 수가 제대로 입력되었는지 확인
      if (isNaN(dailyGoal) || dailyGoal <= 0) {
        alert("목표 문제 수를 제대로 입력해주세요.");
        return;
      }

      // 목표 수 저장되었습니다 메시지 표시
      const goalSavedMessage = document.getElementById('goal-saved-message');
      goalSavedMessage.style.display = 'block';  // 메시지 보이기

      // 1초 후 메시지 숨기기
      setTimeout(() => {
        goalSavedMessage.style.display = 'none';
      }, 1000);

      // 진행률 업데이트 함수 호출 (여기서 진행률 바 업데이트)
      updateProgressBar();

      console.log("🎯 목표 설정 완료! 목표 수:", dailyGoal);
    }

    // +1, -1 버튼으로 푼 문제 수 조정
    function adjustSolvedCount(amount) {
      const current = parseInt(localStorage.getItem('solvedCount') || '0');
      let updated = current + amount;
      if (updated < 0) updated = 0;

      localStorage.setItem('solvedCount', updated);
      updateProgressBar();
      document.getElementById('solvedCountDisplay').textContent = updated;


      // 진행률 업데이트
      updateProgressBar();
    }

    function updateSolvedCount(newSolvedCount) {
      solvedCount = newSolvedCount;
      const goal = parseInt(localStorage.getItem('dailyGoal') || 0);
      updateProgressBar(goal, solvedCount);
    }

    // 진행률 바 업데이트 함수
    function updateProgressBar(goal, solved) {
      const progressBar = document.getElementById('progress-bar');
      const progressBarContainer = document.getElementById('progress-bar-container');

      if (goal === 0) {
        progressBar.style.width = '0%';
      } else {
        const percentage = (solved / goal) * 100;
        progressBar.style.width = percentage + '%';
      }

      // 진행률 바를 화면에 표시
      progressBarContainer.style.display = 'block';
    }

    // 데일리 목표 설정 팝업 열기
    function openGoalModal() {
      const goalModal = document.getElementById('goalModal');
      goalModal.style.display = 'block';  // 팝업 표시

      // 푼 문제 수 표시 업데이트
      const solved = localStorage.getItem('solvedCount') || '0';
      document.getElementById('solvedCountDisplay').textContent = solved;
    }

    // 데일리 목표 설정 팝업 닫기
    function closeGoalModal() {
      const goalModal = document.getElementById('goalModal');
      goalModal.style.display = 'none';  // 팝업 숨기기
    }


    // 등급업 전략 보여주기
    async function getRankUpTip() {
      const bojUsername = localStorage.getItem('bojUsername');
      if (!bojUsername) {
        displayMessage("⚠ 사용자 정보가 없습니다.", 'bot-message');
        return;
      }

      const res = await fetch(`http://127.0.0.1:8000/rankup_tip?boj_username=${bojUsername}`);
      const data = await res.json();

      if (data.error) {
        displayMessage(data.error, 'bot-message');
      } else {
        const rankUpTipHtml = `
          <div style="max-width: 500px; margin-top: 16px; padding: 16px; border-radius: 12px; background-color: #ffffff; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
            <div style="display: flex; align-items: center; margin-bottom: 12px;">
              <span style="font-size: 32px; margin-right: 12px;">📈</span>
              <h4 style="margin: 0; font-size: 20px; color: #6C9D6F;">등급 업 Tip💡</h4>
            </div>
            <div style="font-size: 18px; color: #333; padding-left: 12px; padding-right: 12px; text-align: center;">
              <p style="font-weight: bold; font-size: 22px;">${data.tip}</p>
            </div>
            <div style="text-align: center;">
            </div>
          </div>
        `;
        displayMessage(rankUpTipHtml, 'bot-message');
      }
    }

    let dailyGoal = 0; // 목표 문제 수
    let solvedCount = 0; // 푼 문제 수

    // 목표 설정 저장 함수
    function saveGoal() {
      const goalInput = document.getElementById('goalInput').value;

      // 목표 문제 수 설정
      dailyGoal = parseInt(goalInput);

      if (isNaN(dailyGoal) || dailyGoal <= 0) {
        alert("목표 문제 수를 올바르게 입력해주세요.");
        return;
      }

      // 진행률 업데이트
      updateProgress();

      // 모달 닫기
      closeGoalModal();
    }

    // 진행률 업데이트 함수
    function updateProgress() {
      // 푼 문제 수와 목표 문제 수에 따라 진행률 계산
      const progress = (solvedCount / dailyGoal) * 100;

      // 진행률 바와 현재 푼 문제 수 업데이트
      document.getElementById('goal-progress-bar').style.width = `${progress}%`;
      document.getElementById('solved-count').textContent = solvedCount;
    }

    // 푼 문제 수 +1 버튼 함수
    function incrementSolvedCount() {
      solvedCount++;
      updateProgress();
    }

    // 푼 문제 수 -1 버튼 함수
    function decrementSolvedCount() {
      if (solvedCount > 0) {
        solvedCount--;
        updateProgress();
      }
    }

    // 목표 수정 함수
    function editGoal() {
      const newGoal = prompt("새로운 목표를 설정하세요:");
      if (newGoal && !isNaN(newGoal) && newGoal > 0) {
        localStorage.setItem('dailyGoal', newGoal);
        alert(`목표가 ${newGoal}로 수정되었습니다.`);
        updateProgressBar(newGoal, solvedCount);  // 수정된 목표로 진행률 바 갱신
      } else {
        alert("유효한 목표를 입력해주세요.");
      }
    }

    // 목표 삭제 함수
    function deleteGoal() {
      localStorage.removeItem('dailyGoal');
      alert("목표가 삭제되었습니다.");
      updateProgressBar(0, 0);  // 목표 삭제 후 진행률 바 초기화
      document.getElementById('goal-actions').style.display = 'none';
    }

    window.onload = function () {
      const savedGoal = localStorage.getItem('dailyGoal');
      if (savedGoal) {
        const goal = parseInt(savedGoal);
        updateProgressBar(goal, solvedCount);  // 저장된 목표로 진행률 바 업데이트
        document.getElementById('goal-actions').style.display = 'block';  // 수정/삭제 버튼 보이기
      }
    };

    // 목표 설정
    function setDailyGoal() {
      const goal = parseInt(document.getElementById('goalInput').value);
      if (isNaN(goal) || goal <= 0) {
        alert("유효한 목표 문제 수를 입력해주세요.");
        return;
      }

      localStorage.setItem('dailyGoal', goal);
      localStorage.setItem('solvedToday', 0); // 새 목표 설정 시 초기화
      updateGoalUI();
    }

    // +1 / -1 버튼
    function changeSolvedCount(delta) {
      let current = parseInt(localStorage.getItem('solvedToday') || '0');
      const goal = parseInt(localStorage.getItem('dailyGoal') || '0');

      // +1 / -1을 누를 때마다 푼 문제 수 업데이트
      current = Math.max(0, current + delta); // 0 미만으로 안 내려가게

      // localStorage에 푼 문제 수 저장
      localStorage.setItem('solvedToday', current);

      // UI 업데이트 (푼 문제 수와 목표 업데이트)
      updateGoalUI();

      // 목표 달성 체크: 목표를 달성하면 축하 메시지 표시
      if (goal > 0 && current >= goal) {
        document.getElementById('congratsMessage').style.display = 'block'; // 목표 달성 시 메시지 표시
      } else {
        document.getElementById('congratsMessage').style.display = 'none'; // 목표 미달성 시 메시지 숨김
      }
    }

    // UI 업데이트
    function updateGoalUI() {
      const goal = parseInt(localStorage.getItem('dailyGoal') || '0');
      const solved = parseInt(localStorage.getItem('solvedToday') || '0');

      if (goal > 0) {
        document.getElementById('progress-area').style.display = 'block';
        document.getElementById('goalCount').textContent = goal;
        document.getElementById('solvedCount').textContent = solved;

        const progress = Math.min(100, Math.round((solved / goal) * 100));
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = progress + '%';

        // if (progress === 100) {
        //   alert("🎉 목표를 달성했어요! 수고했어요!");
        // }
      } else {
        document.getElementById('progress-area').style.display = 'none';
      }
    }

    // 목표 초기화
    function resetGoal() {
      localStorage.removeItem('dailyGoal');
      localStorage.removeItem('solvedCount');
      document.getElementById('goalInput').value = '';
      document.getElementById('progress-area').style.display = 'none';
      document.getElementById('congratsMessage').style.display = 'none'; // 메시지도 숨기기
    }

    // 페이지 로드 시 자동 복원
    window.addEventListener('DOMContentLoaded', () => {
      updateGoalUI();
    });

    function showDailyGoalSection() {
      const section = document.getElementById('daily-goal-section');
      section.style.display = 'block';
      section.scrollIntoView({ behavior: 'smooth' });
    }

    async function showDailyGoalModal() {
      document.getElementById('dailyGoalModal').style.display = 'block';

      //   try {
      //   const res = await fetch('http://127.0.0.1:8000/daily_tip');  // ✅ 정상 작동
      //   const data = await res.json();
      //   if (data.tip) {
      //     displayMessage(`💡 ${data.tip}`, 'bot-message');
      //   }
      // } catch (e) {
      //   console.log("GPT 동기부여 실패", e);
      // }
    }


    function closeDailyGoalModal() {
      document.getElementById('dailyGoalModal').style.display = 'none';
    }

    async function fetchPopularProblems() {
  const bojUsername = localStorage.getItem('bojUsername');
  if (!bojUsername) {
    alert("사용자 정보를 찾을 수 없습니다.");
    return;
  }

  try {
    const res = await fetch(`http://127.0.0.1:8000/popular_problems?boj_username=${bojUsername}`);
    const data = await res.json();

    if (data.error) {
      displayMessage(`⚠ ${data.error}`, 'bot-message');
      return;
    }

    let html = `
      <div style="margin-top:10px;">
        <strong>🥇 티어 인기 문제 추천</strong>
        ${data.problems.map(p => `
          <div style="margin-top:8px;">
            <a href="${p.url}" target="_blank">
              📌 ${p.title} (🔥 ${p.solvedCount}명 해결)
            </a>
          </div>`).join('')}
      </div>`;

    displayMessage(html, 'bot-message');

  } catch (error) {
    displayMessage("⚠ 문제를 불러오는 중 오류가 발생했습니다.", 'bot-message');
  }
}

// 기존에 있던 displayMessage 함수 (이미 존재)
function displayMessage(msg, className) {
  const chatBox = document.getElementById('chat-box');
  const div = document.createElement('div');
  div.className = `message ${className}`;
  div.innerHTML = msg;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

async function fetchProblemFeedback(problemId) {
  const res = await fetch(`http://127.0.0.1:8000/problem_feedback?problem_id=${problemId}`);
  const data = await res.json();

  if (data.error) {
    displayMessage("⚠ " + data.error, 'bot-message');
  } else {
    displayMessage("🧠 <strong>전략 요약:</strong><br>" + data.feedback, 'bot-message');
  }
}

  </script>
</body>

</html>