<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Baekjoon Chatbot</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <!-- ğŸ‘¤ ë°±ì¤€ ì•„ì´ë”” ì…ë ¥ í™”ë©´ -->
  <div id="intro-page" style="text-align: center; margin-top: 100px;">
    <h2>ğŸ‘‹ ë°±ì¤€ ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”</h2>
    <input type="text" id="boj-username" placeholder="ex) joonas123" style="padding: 10px; font-size: 16px;" />
    <br /><br />
    <button onclick="startChat()" style="padding: 10px 20px; font-size: 16px;">ì‹œì‘í•˜ê¸°</button>
  </div>

  <!-- ğŸ¤– ì±—ë´‡ í™”ë©´ -->
  <div class="container" id="chat-page" style="display: none;">
    <!-- ë©”ë‰´ ë²„íŠ¼ -->
    <div class="menu-button" onclick="toggleSidebar()">&#9776;</div>

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar" id="sidebar">
      <div class="menu-item" onclick="clearChat()">ğŸ“„ ìƒˆ ì±„íŒ…</div>
      <div class="menu-item" onclick="openSettings()">âš™ ì„¤ì •</div>
    </div>

    <!-- ì„¤ì • í˜ì´ì§€ -->
    <div class="settings-page" id="settings-page" style="display: none;">
      <div class="settings-header" id="settings-header">
        <span>âš™ ì„¤ì •</span>
        <div class="window-controls">
          <button class="close" onclick="closeSettings()">X</button>
        </div>
      </div>
      <div class="menu-item" onclick="toggleStylePopup()">ğŸ¹ í‚¤ë³´ë“œ</div>
      <div id="style-popup" style="display:none; position:fixed; top:60%; left:50%; transform:translate(-50%, -50%);
        background:white; padding:15px; border:1px solid #ccc; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1001;">
        <strong>ğŸ’¡ ê¸€ì”¨ í¬ê¸° ë³€ê²½</strong>
        <div style="margin-top: 10px; display: flex; gap: 10px;">
          <button onclick="setFontSize('small')">ì‘ê²Œ</button>
          <button onclick="setFontSize('medium')">ë³´í†µ</button>
          <button onclick="setFontSize('large')">í¬ê²Œ</button>
        </div>
      </div>
      <label><input type="checkbox" id="dark-mode-toggle" /> ë‹¤í¬ ëª¨ë“œ í™œì„±í™”</label><br />
      <button onclick="saveChatHistory()">ğŸ’¾ ì±„íŒ… ì €ì¥</button>
      <button onclick="loadChatHistory()">ğŸ“‚ ì±„íŒ… ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>

    <!-- ì±„íŒ…ì°½ -->
    <div class="chat-container">
      <div class="chat-box" id="chat-box">
        <div class="message bot-message">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
      </div>
      <textarea class="input-box" id="input-box" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
      <div class="file-voice-container">
        <input type="file" id="file-input" title="CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”" />
        <button class="voice-button" onclick="startSpeechRecognition()">ğŸ¤</button>
      </div>
      <button class="send-button" onclick="sendMessage()">ì „ì†¡</button>
    </div>
  </div>

  <script>
    // â–¶ ì•„ì´ë”” ì…ë ¥ í›„ ì±—ë´‡ í˜ì´ì§€ë¡œ ì „í™˜
    function startChat() {
      const username = document.getElementById('boj-username').value.trim();
      if (!username) {
        alert('ë°±ì¤€ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }
      localStorage.setItem('bojUsername', username);
      document.getElementById('intro-page').style.display = 'none';
      document.getElementById('chat-page').style.display = 'flex';
    }

    // â–¶ ë©”ì‹œì§€ ì „ì†¡ ì²˜ë¦¬
    async function sendMessage() {
      const inputBox = document.getElementById('input-box');
      const fileInput = document.getElementById('file-input');
      const message = inputBox.value.trim();
      const bojUsername = localStorage.getItem('bojUsername') || "";

      if (!message) return;

      displayMessage(message, 'user-message');
      inputBox.value = '';

      const formData = new FormData();
      formData.append('question', message);
      formData.append('boj_username', bojUsername);

      const url = fileInput.files.length > 0 ? 'http://127.0.0.1:8000/analyze' : 'http://127.0.0.1:8000/chat';

      try {
        const response = await fetch(url, { method: 'POST', body: formData });
        const data = await response.json();
        displayMessage(data.summary || data.answer || "ì˜¤ë¥˜ ë°œìƒ", 'bot-message');
      } catch (error) {
        displayMessage("âš  ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ", 'bot-message');
      }
    }

    // â–¶ ê³µí†µ ë©”ì‹œì§€ í‘œì‹œ
    function displayMessage(msg, className) {
      const chatBox = document.getElementById('chat-box');
      const div = document.createElement('div');
      div.className = `message ${className}`;
      div.textContent = msg;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ì—”í„° í‚¤ë¡œ ì „ì†¡
    document.getElementById('input-box').addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // ë‹¤í¬ ëª¨ë“œ í† ê¸€
    document.getElementById('dark-mode-toggle').addEventListener('change', function () {
      document.body.classList.toggle('dark-mode', this.checked);
      localStorage.setItem('darkMode', this.checked);
    });

    // ì´ˆê¸° ì„¸íŒ…
    window.onload = function () {
      const savedDark = localStorage.getItem('darkMode') === 'true';
      document.body.classList.toggle('dark-mode', savedDark);
      document.getElementById('dark-mode-toggle').checked = savedDark;
    };

    // ì„¤ì • ê´€ë ¨ í•¨ìˆ˜ë“¤
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    function clearChat() {
      document.getElementById('chat-box').innerHTML = '<div class="message bot-message">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>';
    }

    function openSettings() {
      document.getElementById('settings-page').style.display = 'block';
    }

    function closeSettings() {
      document.getElementById('settings-page').style.display = 'none';
    }

    function toggleStylePopup() {
      const popup = document.getElementById("style-popup");
      popup.style.display = popup.style.display === "none" ? "block" : "none";
    }

    function setFontSize(size) {
      const messages = document.querySelectorAll('.bot-message');
      messages.forEach(msg => {
        msg.classList.remove('size-small', 'size-medium', 'size-large');
        msg.classList.add(`size-${size}`);
      });
    }

    function saveChatHistory() {
      localStorage.setItem('chatHistory', document.getElementById('chat-box').innerHTML);
      alert('ì±„íŒ…ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    function loadChatHistory() {
      const savedChat = localStorage.getItem('chatHistory');
      if (savedChat) {
        document.getElementById('chat-box').innerHTML = savedChat;
      } else {
        alert('ì €ì¥ëœ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.');
      }
    }

    function startSpeechRecognition() {
      alert("ğŸ¤ ìŒì„± ì¸ì‹ ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ ì¤‘ì´ì—ìš”!");
    }
  </script>
</body>

</html>
